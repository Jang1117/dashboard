<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jang's Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-card: #222222;
      --bg-hover: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;
      --accent: #4ecdc4;
      --accent-hover: #45b7aa;
      --border: #333333;
      --success: #4ade80;
      --warning: #fbbf24;
      --danger: #f87171;
      --memo-yellow: #fef3c7;
      --memo-pink: #fce7f3;
      --memo-blue: #dbeafe;
      --memo-green: #d1fae5;
      --memo-purple: #ede9fe;
      --google-blue: #4285f4;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 30px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--accent);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .current-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    /* Weather */
    .weather-inline {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-card);
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .weather-icon { font-size: 1.5rem; }
    .weather-temp { font-size: 1.2rem; font-weight: 600; }
    .weather-desc { font-size: 0.85rem; color: var(--text-secondary); }
    .weather-location { font-size: 0.75rem; color: var(--text-muted); }

    /* Layout */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 16px;
      padding: 16px 30px;
      max-width: 1600px;
      margin: 0 auto;
      height: calc(100vh - 70px);
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      transition: all 0.3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 30px rgba(78, 205, 196, 0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      gap: 10px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .card-title-icon { color: var(--accent); }

    .card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .card-btn {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.82rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .card-btn:hover {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    /* ====== BOOKMARKS: ê·¸ë£¹ ë°•ìŠ¤ í˜•íƒœ + DnD ====== */

    /* ì¦ê²¨ì°¾ê¸° ì „ì²´ ìŠ¤í¬ë¡¤ ì˜ì—­ */
    .bookmark-groups-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 10px 6px 6px 6px; /* âœ… FIX: ìƒë‹¨ ì—¬ë°±ìœ¼ë¡œ hover/ì ì„  í…Œë‘ë¦¬ ì§¤ë¦¼ ë°©ì§€ */
      align-content: start;
    }

    /* ê·¸ë£¹ ë°•ìŠ¤ */
    .bookmark-group {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      margin-bottom: 12px;
      transition: border-color .2s, box-shadow .2s;
    }

    .bookmark-group.drag-over {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.12);
    }

    .bookmark-group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    .bookmark-group-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 0.92rem;
      color: var(--text-primary);
      min-width: 0;
    }

    .bookmark-group-title span.name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 320px;
    }

    .bookmark-group-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
      white-space: nowrap;
    }

    .bookmark-group-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .mini-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.78rem;
      transition: all .2s;
      white-space: nowrap;
    }
    .mini-btn:hover {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }
    .mini-btn.danger:hover {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }

    /* ê·¸ë£¹ ì•ˆ ë¶ë§ˆí¬ grid */
    .bookmarks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 10px;
      padding-top: 4px; /* âœ… FIX: hover í…Œë‘ë¦¬ ì•ˆì • */
    }

    /* ê°œë³„ ë¶ë§ˆí¬ íƒ€ì¼ */
    .bookmark-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: grab;
      transition: border-color .2s, box-shadow .2s, background .2s;
      position: relative;
      height: 52px;
      user-select: none;
    }

    /* âœ… FIX: ìœ„ë¡œ ë– ì„œ ì˜ë¦¬ëŠ” ì›ì¸(transform) ì œê±° */
    .bookmark-item:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.12);
    }

    .bookmark-item:active {
      cursor: grabbing;
    }

    .bookmark-item.dragging {
      opacity: 0.55;
      border-style: dashed;
    }

    .bookmark-icon {
      width: 28px;
      height: 28px;
      min-width: 28px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.0rem;
    }

    .bookmark-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    /* ì‚­ì œ X ë²„íŠ¼: ë‚´ë¶€ë¡œ ê³ ì • */
    .bookmark-delete {
      position: absolute;
      top: 7px;
      right: 7px;
      width: 18px;
      height: 18px;
      background: var(--danger);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 11px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .bookmark-item:hover .bookmark-delete { display: flex; }

    /* ê·¸ë£¹ ë‚´ +ì¶”ê°€ íƒ€ì¼ */
    .bookmark-add {
      background: rgba(0,0,0,0.0);
      border: 2px dashed var(--border);
      color: var(--text-secondary);
      justify-content: center;
      cursor: pointer;
    }
    .bookmark-add:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(78, 205, 196, 0.08);
      box-shadow: none;
    }
    .bookmark-add .bookmark-icon {
      background: transparent;
      border: none;
      font-weight: 900;
    }

    /* Calendar, Memo, News: ì›ë³¸ ìœ ì§€ (í•„ìš” ìµœì†Œ ìˆ˜ì •ë§Œ) */
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
    }
    .calendar-nav { display: flex; gap: 6px; }
    .calendar-nav button {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    .calendar-nav button:hover { background: var(--accent); color: var(--bg-primary); }
    .calendar-week-label { font-weight: 600; color: var(--text-primary); font-size: 0.9rem; }

    .google-status {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 10px; background: var(--bg-secondary);
      border-radius: 6px; margin-bottom: 8px; font-size: 0.75rem;
    }
    .google-status.connected { border: 1px solid #4285f4; }
    .google-status.disconnected { border: 1px solid var(--border); }
    .google-status-text { flex: 1; color: var(--text-secondary); }
    .google-btn {
      background: #4285f4;
      border: none; color: white; padding: 4px 10px;
      border-radius: 5px; cursor: pointer;
      font-size: 0.75rem; transition: background 0.2s;
    }
    .google-btn:hover { background: #3367d6; }
    .google-btn.disconnect { background: var(--bg-hover); color: var(--text-secondary); }
    .google-btn.disconnect:hover { background: var(--danger); color: white; }

    .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 10px; }
    .week-day {
      text-align: center; padding: 8px 4px;
      background: var(--bg-secondary); border-radius: 6px;
      cursor: pointer; transition: all 0.2s; border: 2px solid transparent;
    }
    .week-day:hover { background: var(--bg-hover); }
    .week-day.today { background: var(--accent); color: var(--bg-primary); }
    .week-day.today .week-day-name { color: var(--bg-primary); }
    .week-day.selected { border-color: var(--accent); background: rgba(78, 205, 196, 0.15); }
    .week-day-name { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2px; }
    .week-day-num { font-size: 1rem; font-weight: 600; }
    .week-day-dots { display: flex; justify-content: center; gap: 2px; margin-top: 4px; min-height: 5px; }
    .event-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); }
    .week-day.today .event-dot { background: var(--bg-primary); }

    .events-date-header {
      font-size: 0.8rem; color: var(--text-muted);
      margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border);
    }
    .events-list { height: 88px; min-height: 88px; max-height: 88px; overflow-y: auto; }
    .event-item {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 10px; background: var(--bg-secondary);
      border-radius: 6px; margin-bottom: 4px;
      border-left: 3px solid var(--accent); font-size: 0.85rem;
    }
    .event-item.google-event { border-left-color: #4285f4; }
    .event-time { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent); min-width: 80px; }
    .event-item.google-event .event-time { color: #4285f4; }
    .event-title { flex: 1; }
    .event-source {
      font-size: 0.65rem; color: var(--text-muted);
      background: var(--bg-hover); padding: 2px 5px; border-radius: 3px;
    }
    .event-empty { text-align: center; color: var(--text-muted); padding: 30px 16px; font-size: 0.85rem; }

    /* Memo */
    .memo-container { min-height: 200px; max-height: 200px; }
    .memo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; padding: 4px; }
    .memo-postit {
      background: var(--memo-yellow); border-radius: 4px; padding: 10px;
      min-height: 90px; max-height: 90px; cursor: pointer; transition: all 0.2s;
      position: relative; box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .memo-postit:hover { transform: translateY(-3px) rotate(1deg); box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.4); }
    .memo-postit.yellow { background: var(--memo-yellow); }
    .memo-postit.pink { background: var(--memo-pink); }
    .memo-postit.blue { background: var(--memo-blue); }
    .memo-postit.green { background: var(--memo-green); }
    .memo-postit.purple { background: var(--memo-purple); }

    .memo-postit-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .memo-postit-title { font-size: 0.8rem; font-weight: 600; color: #333; flex: 1; word-break: break-word; }
    .memo-postit-date { font-size: 0.65rem; color: #666; }
    .memo-postit-content {
      font-size: 0.7rem; color: #444; flex: 1; overflow: hidden;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      line-height: 1.3; word-break: break-word;
    }
    .memo-postit-delete {
      position: absolute; top: 4px; right: 4px; width: 18px; height: 18px;
      background: rgba(0, 0, 0, 0.3); border: none; border-radius: 50%;
      color: white; font-size: 10px; cursor: pointer; display: none;
      align-items: center; justify-content: center;
    }
    .memo-postit:hover .memo-postit-delete { display: flex; }
    .memo-postit-add {
      background: var(--bg-secondary); border: 2px dashed var(--border);
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted); font-size: 2rem;
    }
    .memo-postit-add:hover {
      border-color: var(--accent); color: var(--accent);
      transform: none; box-shadow: none;
    }

    /* News */
    .news-keyword-bar { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
    .news-keyword {
      background: var(--bg-secondary); border: 1px solid var(--border);
      padding: 4px 12px; border-radius: 16px; font-size: 0.8rem;
      color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
    }
    .news-keyword:hover, .news-keyword.active {
      background: var(--accent); color: var(--bg-primary); border-color: var(--accent);
    }
    .news-list { max-height: 200px; overflow-y: auto; }
    .news-item {
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
      padding: 8px 10px; background: var(--bg-secondary); border-radius: 5px;
      margin-bottom: 4px; text-decoration: none; transition: all 0.2s; border: 1px solid transparent;
    }
    .news-item:hover { background: var(--bg-hover); border-color: var(--accent); }
    .news-title {
      color: var(--text-primary); font-size: 0.78rem; line-height: 1.3;
      flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .news-time { font-size: 0.7rem; color: var(--text-muted); white-space: nowrap; flex-shrink: 0; }
    .news-loading { text-align: center; padding: 30px; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 520px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .modal-title { font-size: 1.1rem; font-weight: 600; }
    .modal-close {
      background: none; border: none; color: var(--text-muted);
      font-size: 1.5rem; cursor: pointer;
    }
    .modal-close:hover { color: var(--text-primary); }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85rem; }
    .form-input, .form-textarea {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .form-textarea { min-height: 120px; resize: vertical; }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }

    .form-color-options { display: flex; gap: 8px; }
    .color-option {
      width: 28px; height: 28px; border-radius: 50%;
      border: 2px solid transparent; cursor: pointer; transition: all 0.2s;
    }
    .color-option:hover, .color-option.selected { transform: scale(1.1); border-color: var(--text-primary); }
    .color-option.yellow { background: var(--memo-yellow); }
    .color-option.pink { background: var(--memo-pink); }
    .color-option.blue { background: var(--memo-blue); }
    .color-option.green { background: var(--memo-green); }
    .color-option.purple { background: var(--memo-purple); }

    .form-submit {
      width: 100%;
      background: var(--accent);
      border: none;
      color: var(--bg-primary);
      padding: 12px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .form-submit:hover { background: var(--accent-hover); }

    /* Settings Dropdown */
    .settings-dropdown { position: relative; }
    .settings-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .settings-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .settings-menu {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      min-width: 180px;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .settings-menu.active { display: block; }
    .settings-menu button {
      display: block; width: 100%;
      background: none; border: none;
      color: var(--text-secondary);
      padding: 10px 12px;
      text-align: left;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .settings-menu button:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-left">
      <h1>Jang's Dashboard</h1>
    </div>
    <div class="header-right">
      <div class="weather-inline" id="weatherWidget">
        <span class="weather-icon" id="weatherIcon">ğŸŒ¡ï¸</span>
        <div>
          <span class="weather-temp" id="weatherTemp">--Â°</span>
          <span class="weather-desc" id="weatherDesc">ë¡œë”©ì¤‘...</span>
        </div>
        <span class="weather-location" id="weatherLocation">ğŸ“ --</span>
      </div>
      <div class="current-time" id="currentTime">00:00:00</div>

      <div class="settings-dropdown">
        <button class="settings-btn" onclick="toggleSettingsMenu()">âš™ï¸ ì„¤ì •</button>
        <div class="settings-menu" id="settingsMenu">
          <button onclick="exportToJson()">ğŸ“¥ JSON ë‚´ë³´ë‚´ê¸°</button>
          <button onclick="document.getElementById('jsonFileInput').click()">ğŸ“¤ JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="importFromJson(event)">
        </div>
      </div>
    </div>
  </header>

  <main class="main-container">
    <!-- Bookmarks -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="card-title-icon">â­</span>
          ì¦ê²¨ì°¾ëŠ” ì‚¬ì´íŠ¸
        </div>

        <!-- âœ… ê°™ì€ ì¤„: ê·¸ë£¹ê´€ë¦¬ + ì‚¬ì´íŠ¸ì¶”ê°€ -->
        <div class="card-actions">
          <button class="card-btn" onclick="openBookmarkGroupModal()">ê·¸ë£¹ ê´€ë¦¬</button>
          <button class="card-btn" onclick="openAddBookmarkModal()">ì‚¬ì´íŠ¸ ì¶”ê°€</button>
        </div>
      </div>

      <!-- âœ… ê·¸ë£¹ ë°•ìŠ¤ë“¤ì´ ë“¤ì–´ê°€ëŠ” ìŠ¤í¬ë¡¤ ì˜ì—­ -->
      <div class="bookmark-groups-scroll" id="bookmarkGroupsScroll"></div>
    </div>

    <!-- Calendar -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="card-title-icon">ğŸ“…</span>ì£¼ê°„ ì¼ì •</div>
        <div class="card-actions">
          <button class="card-btn" onclick="openAddEventModal()">+ ì¼ì •</button>
        </div>
      </div>

      <div class="google-status disconnected" id="googleStatus">
        <span>ğŸ“†</span>
        <span class="google-status-text" id="googleStatusText">Google ìº˜ë¦°ë” ì—°ê²° ì•ˆë¨</span>
        <button class="google-btn" id="googleBtn" onclick="handleGoogleAuth()">ì—°ê²°</button>
        <button class="google-btn" id="googleCalendarSelectBtn" onclick="openCalendarSelectModal()" style="display:none;">ìº˜ë¦°ë” ì„ íƒ</button>
      </div>

      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="changeWeek(-1)">â—€</button>
          <button onclick="goToToday()">ì˜¤ëŠ˜</button>
          <button onclick="changeWeek(1)">â–¶</button>
        </div>
        <div class="calendar-week-label" id="calendarWeekLabel">1ì›” 2ì£¼ì°¨</div>
      </div>

      <div class="week-grid" id="weekGrid"></div>
      <div id="selectedDateHeader" class="events-date-header"></div>
      <div class="events-list" id="eventsList"></div>
    </div>

    <!-- Memo -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="card-title-icon">ğŸ“</span>ë©”ëª¨</div>
        <div class="card-actions">
          <button class="card-btn" onclick="exportAllMemos()">ë‚´ë³´ë‚´ê¸°</button>
        </div>
      </div>
      <div class="memo-container">
        <div class="memo-grid" id="memoGrid"></div>
      </div>
    </div>

    <!-- News -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="card-title-icon">ğŸ“°</span>ë‰´ìŠ¤</div>
        <div class="card-actions">
          <button class="card-btn" onclick="openKeywordModal()">í‚¤ì›Œë“œ</button>
          <button class="card-btn" onclick="refreshNews()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div class="news-keyword-bar" id="newsKeywords"></div>
      <div class="news-list" id="newsList">
        <div class="news-loading">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </main>

  <!-- Add Bookmark Modal -->
  <div class="modal-overlay" id="bookmarkModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ì‚¬ì´íŠ¸ ì¶”ê°€</div>
        <button class="modal-close" onclick="closeModal('bookmarkModal')">Ã—</button>
      </div>

      <form onsubmit="addBookmark(event)">
        <div class="form-group">
          <label class="form-label">ì‚¬ì´íŠ¸ ì´ë¦„</label>
          <input type="text" class="form-input" id="bookmarkName" placeholder="ì˜ˆ: ChatGPT" required>
        </div>

        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="url" class="form-input" id="bookmarkUrl" placeholder="https://..." required>
        </div>

        <div class="form-group">
          <label class="form-label">ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
          <input type="text" class="form-input" id="bookmarkIcon" placeholder="ğŸŒ" maxlength="2">
        </div>

        <div class="form-group">
          <label class="form-label">ê·¸ë£¹</label>
          <select class="form-input" id="bookmarkGroup"></select>
        </div>

        <button type="submit" class="form-submit">ì¶”ê°€í•˜ê¸°</button>
      </form>
    </div>
  </div>

  <!-- Bookmark Group Modal -->
  <div class="modal-overlay" id="bookmarkGroupModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ê·¸ë£¹ ê´€ë¦¬</div>
        <button class="modal-close" onclick="closeModal('bookmarkGroupModal')">Ã—</button>
      </div>

      <div class="form-group">
        <label class="form-label">ìƒˆ ê·¸ë£¹ ì¶”ê°€</label>
        <div style="display:flex; gap:8px;">
          <input type="text" class="form-input" id="newBookmarkGroupName" placeholder="ì˜ˆ: AI, ì—…ë¬´, ì‡¼í•‘">
          <button class="card-btn" type="button" onclick="addBookmarkGroup()">ì¶”ê°€</button>
        </div>
      </div>

      <div style="margin-top: 16px;">
        <label class="form-label">í˜„ì¬ ê·¸ë£¹</label>
        <div id="bookmarkGroupList" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ì¼ì • ì¶”ê°€</div>
        <button class="modal-close" onclick="closeModal('eventModal')">Ã—</button>
      </div>
      <form onsubmit="addEvent(event)">
        <div class="form-group">
          <label class="form-label">ì¼ì • ì œëª©</label>
          <input type="text" class="form-input" id="eventTitle" placeholder="íšŒì˜, ì•½ì† ë“±" required>
        </div>
        <div class="form-group">
          <label class="form-label">ë‚ ì§œ</label>
          <input type="date" class="form-input" id="eventDate" required>
        </div>
        <div class="form-group">
          <label class="form-label">ì‹œê°„</label>
          <input type="time" class="form-input" id="eventTime">
        </div>
        <button type="submit" class="form-submit">ì¶”ê°€í•˜ê¸°</button>
      </form>
    </div>
  </div>

  <!-- Add/Edit Memo Modal -->
  <div class="modal-overlay" id="memoModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="memoModalTitle">ë©”ëª¨ ì¶”ê°€</div>
        <button class="modal-close" onclick="closeModal('memoModal')">Ã—</button>
      </div>
      <form onsubmit="saveMemo(event)">
        <input type="hidden" id="memoEditIndex" value="-1">
        <div class="form-group">
          <label class="form-label">ì œëª©</label>
          <input type="text" class="form-input" id="memoTitle" placeholder="ë©”ëª¨ ì œëª©" required>
        </div>
        <div class="form-group">
          <label class="form-label">ë‚´ìš©</label>
          <textarea class="form-textarea" id="memoContent" placeholder="ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ìƒ‰ìƒ</label>
          <div class="form-color-options" id="colorOptions">
            <div class="color-option yellow selected" data-color="yellow" onclick="selectColor('yellow')"></div>
            <div class="color-option pink" data-color="pink" onclick="selectColor('pink')"></div>
            <div class="color-option blue" data-color="blue" onclick="selectColor('blue')"></div>
            <div class="color-option green" data-color="green" onclick="selectColor('green')"></div>
            <div class="color-option purple" data-color="purple" onclick="selectColor('purple')"></div>
          </div>
        </div>
        <button type="submit" class="form-submit">ì €ì¥í•˜ê¸°</button>
      </form>
    </div>
  </div>

  <!-- Keyword Modal -->
  <div class="modal-overlay" id="keywordModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ë‰´ìŠ¤ í‚¤ì›Œë“œ ê´€ë¦¬</div>
        <button class="modal-close" onclick="closeModal('keywordModal')">Ã—</button>
      </div>
      <form onsubmit="addKeyword(event)">
        <div class="form-group">
          <label class="form-label">ìƒˆ í‚¤ì›Œë“œ</label>
          <input type="text" class="form-input" id="newKeyword" placeholder="ì˜ˆ: AI, ì£¼ì‹, ë¶€ë™ì‚°" required>
        </div>
        <button type="submit" class="form-submit">ì¶”ê°€í•˜ê¸°</button>
      </form>
      <div style="margin-top: 16px;">
        <label class="form-label">í˜„ì¬ í‚¤ì›Œë“œ (í´ë¦­í•˜ì—¬ ì‚­ì œ)</label>
        <div id="keywordList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
      </div>
    </div>
  </div>

  <!-- Calendar Select Modal -->
  <div class="modal-overlay" id="calendarSelectModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">í‘œì‹œí•  ìº˜ë¦°ë” ì„ íƒ</div>
        <button class="modal-close" onclick="closeModal('calendarSelectModal')">Ã—</button>
      </div>
      <div id="calendarList" style="max-height: 300px; overflow-y: auto;">
        <div class="news-loading">ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
      <button class="form-submit" onclick="saveCalendarSelection()" style="margin-top: 16px;">ì €ì¥</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ==================== State ====================
    let state = {
      bookmarks: [],
      bookmarkGroups: [{ id: 'default', name: 'ê¸°ë³¸' }],
      events: [],
      googleEvents: [],
      googleCalendars: [],
      selectedCalendars: [],
      memos: [],
      newsKeywords: ['IT', 'ê²½ì œ', 'ë¶€ë™ì‚°'],
      activeKeyword: 'IT',
      newsProvider: 'naver',
      currentWeekStart: null,
      selectedDate: null,
      googleConnected: false,
      googleAccessToken: null,
      selectedMemoColor: 'yellow'
    };

    // Google Calendar API
    const GOOGLE_CLIENT_ID = '616051020242-mg4r2ccc0iks3ssqhjuula6f1sr1o0p8.apps.googleusercontent.com';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

    // ë¡œì»¬ ë‚ ì§œ ë¬¸ìì—´ ìƒì„±
    function getLocalDateStr(date) {
      const d = date || new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseLocalDate(dateStr) {
      const [year, month, day] = dateStr.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function uid(prefix = 'id') {
      return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
    }

    // ==================== Storage ====================
    function loadState() {
      const saved = localStorage.getItem('dashboardState_v3');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        } catch (e) {}
      }

      const googleToken = localStorage.getItem('googleAccessToken');
      if (googleToken) {
        state.googleAccessToken = googleToken;
        state.googleConnected = true;
      }

      // ë‚ ì§œ/ì£¼ ì´ˆê¸°í™”
      state.currentWeekStart = getWeekStart(new Date());
      state.selectedDate = getLocalDateStr(new Date());

      normalizeBookmarksAndGroups();
    }

    function saveState() {
      const toSave = {
        bookmarks: state.bookmarks,
        bookmarkGroups: state.bookmarkGroups,
        events: state.events,
        memos: state.memos,
        newsKeywords: state.newsKeywords,
        newsProvider: state.newsProvider,
        selectedCalendars: state.selectedCalendars
      };
      localStorage.setItem('dashboardState_v3', JSON.stringify(toSave));
    }

    // ==================== Migration / Normalize ====================
    function normalizeBookmarksAndGroups() {
      // groups ë³´ì •
      if (!Array.isArray(state.bookmarkGroups) || state.bookmarkGroups.length === 0) {
        state.bookmarkGroups = [{ id: 'default', name: 'ê¸°ë³¸' }];
      }
      if (!state.bookmarkGroups.some(g => g.id === 'default')) {
        state.bookmarkGroups.unshift({ id: 'default', name: 'ê¸°ë³¸' });
      }

      // bookmarks ë³´ì •
      if (!Array.isArray(state.bookmarks)) state.bookmarks = [];

      state.bookmarks = state.bookmarks.map(b => ({
        id: b.id || uid('bm'),
        name: b.name || '(ì´ë¦„ ì—†ìŒ)',
        url: b.url || '#',
        icon: b.icon || 'ğŸ”—',
        groupId: b.groupId || 'default'
      }));

      // ì¡´ì¬í•˜ì§€ ì•ŠëŠ” groupIdëŠ” defaultë¡œ
      const groupIds = new Set(state.bookmarkGroups.map(g => g.id));
      state.bookmarks = state.bookmarks.map(b => groupIds.has(b.groupId) ? b : ({ ...b, groupId: 'default' }));

      // ê¸°ë³¸ ë¶ë§ˆí¬ ì£¼ì…(ì´ˆê¸°)
      if (state.bookmarks.length === 0) {
        state.bookmarks = [
          { id: uid('bm'), name: 'ChatGPT', url: 'https://chat.openai.com', icon: 'ğŸ¤–', groupId: 'default' },
          { id: uid('bm'), name: 'Gemini', url: 'https://gemini.google.com', icon: 'âœ¨', groupId: 'default' },
          { id: uid('bm'), name: 'Claude', url: 'https://claude.ai', icon: 'âœï¸', groupId: 'default' },
          { id: uid('bm'), name: 'GitHub', url: 'https://github.com', icon: 'ğŸ’»', groupId: 'default' }
        ];
        saveState();
      }
    }

    // ==================== Init ====================
    function init() {
      loadState();
      handleOAuthCallback();

      updateTime();
      setInterval(updateTime, 1000);

      getWeather();
      renderBookmarkGroups();  // âœ… ê·¸ë£¹ ë°•ìŠ¤ ë Œë”
      updateGoogleStatus();
      renderWeeklyCalendar();
      renderMemos();
      renderNewsKeywords();
      loadNews();

      if (state.googleConnected) {
        fetchGoogleCalendarList();
        fetchGoogleCalendarEvents();
      }
    }

    // ==================== Settings JSON ====================
    function toggleSettingsMenu() {
      document.getElementById('settingsMenu').classList.toggle('active');
    }

    document.addEventListener('click', (e) => {
      const dropdown = document.querySelector('.settings-dropdown');
      const menu = document.getElementById('settingsMenu');
      if (dropdown && !dropdown.contains(e.target)) menu.classList.remove('active');
    });

    function exportToJson() {
      const exportData = {
        version: '2.0',
        exportDate: getLocalDateStr(new Date()),
        bookmarks: state.bookmarks,
        bookmarkGroups: state.bookmarkGroups,
        events: state.events,
        memos: state.memos,
        newsKeywords: state.newsKeywords,
        newsProvider: state.newsProvider,
        selectedCalendars: state.selectedCalendars
      };
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dashboard_backup_${getLocalDateStr(new Date())}.json`;
      a.click();
      URL.revokeObjectURL(url);
      document.getElementById('settingsMenu').classList.remove('active');
      alert('ì„¤ì •ì´ JSON íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function importFromJson(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importData = JSON.parse(e.target.result);

          if (importData.bookmarks) state.bookmarks = importData.bookmarks;
          if (importData.bookmarkGroups) state.bookmarkGroups = importData.bookmarkGroups;
          if (importData.events) state.events = importData.events;
          if (importData.memos) state.memos = importData.memos;
          if (importData.newsKeywords) state.newsKeywords = importData.newsKeywords;
          if (importData.newsProvider) state.newsProvider = importData.newsProvider;
          if (importData.selectedCalendars) state.selectedCalendars = importData.selectedCalendars;

          normalizeBookmarksAndGroups();
          saveState();

          renderBookmarkGroups();
          renderWeeklyCalendar();
          renderMemos();
          renderNewsKeywords();
          loadNews();

          alert('ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
          alert('JSON íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          console.error(err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
      document.getElementById('settingsMenu').classList.remove('active');
    }

    // ==================== Time ====================
    function updateTime() {
      document.getElementById('currentTime').textContent =
        new Date().toLocaleTimeString('ko-KR', { hour12: false });
    }

    // ==================== Weather ====================
    async function getWeather() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
          () => fetchWeather(37.5665, 126.9780)
        );
      } else {
        fetchWeather(37.5665, 126.9780);
      }
    }

    async function fetchWeather(lat, lon) {
      try {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`);
        const data = await res.json();

        const temp = Math.round(data.current.temperature_2m);
        const code = data.current.weather_code;

        document.getElementById('weatherTemp').textContent = temp + 'Â°';
        document.getElementById('weatherDesc').textContent = getWeatherDesc(code);
        document.getElementById('weatherIcon').textContent = getWeatherIcon(code);

        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ko`);
        const geoData = await geoRes.json();
        const loc = geoData.address.city || geoData.address.town || geoData.address.district || 'ì•Œ ìˆ˜ ì—†ìŒ';
        document.getElementById('weatherLocation').textContent = 'ğŸ“ ' + loc;
      } catch (e) {
        document.getElementById('weatherDesc').textContent = 'ë‚ ì”¨ ì •ë³´ ì—†ìŒ';
      }
    }

    function getWeatherIcon(code) {
      const icons = { 0:'â˜€ï¸', 1:'ğŸŒ¤ï¸', 2:'â›…', 3:'â˜ï¸', 45:'ğŸŒ«ï¸', 48:'ğŸŒ«ï¸', 51:'ğŸŒ§ï¸', 53:'ğŸŒ§ï¸', 55:'ğŸŒ§ï¸', 61:'ğŸŒ§ï¸', 63:'ğŸŒ§ï¸', 65:'ğŸŒ§ï¸', 71:'ğŸŒ¨ï¸', 73:'ğŸŒ¨ï¸', 75:'ğŸŒ¨ï¸', 80:'ğŸŒ§ï¸', 81:'ğŸŒ§ï¸', 82:'ğŸŒ§ï¸', 95:'â›ˆï¸', 96:'â›ˆï¸', 99:'â›ˆï¸' };
      return icons[code] || 'ğŸŒ¡ï¸';
    }

    function getWeatherDesc(code) {
      const desc = { 0:'ë§‘ìŒ', 1:'ëŒ€ì²´ë¡œ ë§‘ìŒ', 2:'ë¶€ë¶„ì  íë¦¼', 3:'íë¦¼', 45:'ì•ˆê°œ', 48:'ì•ˆê°œ', 51:'ì´ìŠ¬ë¹„', 53:'ì´ìŠ¬ë¹„', 55:'ì´ìŠ¬ë¹„', 61:'ë¹„', 63:'ë¹„', 65:'í­ìš°', 71:'ëˆˆ', 73:'ëˆˆ', 75:'í­ì„¤', 80:'ì†Œë‚˜ê¸°', 81:'ì†Œë‚˜ê¸°', 82:'í­ìš°', 95:'ë‡Œìš°', 96:'ë‡Œìš°', 99:'ë‡Œìš°' };
      return desc[code] || 'ì •ë³´ ì—†ìŒ';
    }

    // ==================== Bookmarks: Render (ê·¸ë£¹ ë°•ìŠ¤) ====================
    function renderBookmarkGroups() {
      const wrap = document.getElementById('bookmarkGroupsScroll');

      wrap.innerHTML = state.bookmarkGroups.map(g => {
        const items = state.bookmarks.filter(b => b.groupId === g.id);
        const count = items.length;

        const gridHtml = items.map(b => `
          <div class="bookmark-item"
               draggable="true"
               data-bm-id="${b.id}"
               ondragstart="onBookmarkDragStart(event, '${b.id}')"
               ondragend="onBookmarkDragEnd(event)"
               onclick="openBookmarkUrl('${escapeQuotes(b.url)}')">
            <button class="bookmark-delete" onclick="deleteBookmark(event, '${b.id}')">Ã—</button>
            <div class="bookmark-icon">${b.icon || 'ğŸ”—'}</div>
            <div class="bookmark-name" title="${escapeHtml(b.name)}">${escapeHtml(b.name)}</div>
          </div>
        `).join('');

        const addTile = `
          <div class="bookmark-item bookmark-add"
               onclick="openAddBookmarkModal('${g.id}')"
               ondragover="onGroupDragOver(event)"
               ondrop="onGroupDrop(event, '${g.id}')">
            <div class="bookmark-icon">+</div>
            <div class="bookmark-name">ì¶”ê°€</div>
          </div>
        `;

        return `
          <div class="bookmark-group"
               id="group_${g.id}"
               ondragover="onGroupDragOver(event)"
               ondrop="onGroupDrop(event, '${g.id}')"
               ondragleave="onGroupDragLeave(event, '${g.id}')">
            <div class="bookmark-group-header">
              <div class="bookmark-group-title">
                ğŸ“ <span class="name" title="${escapeHtml(g.name)}">${escapeHtml(g.name)}</span>
                <span class="bookmark-group-meta">(${count})</span>
              </div>
              <div class="bookmark-group-actions">
                <button class="mini-btn" type="button" onclick="renameBookmarkGroup('${g.id}')">ì´ë¦„ë³€ê²½</button>
                ${g.id === 'default'
                  ? `<button class="mini-btn danger" type="button" disabled style="opacity:.45; cursor:not-allowed;">ì‚­ì œ</button>`
                  : `<button class="mini-btn danger" type="button" onclick="deleteBookmarkGroup('${g.id}')">ì‚­ì œ</button>`
                }
              </div>
            </div>

            <div class="bookmarks-grid">
              ${gridHtml}
              ${addTile}
            </div>
          </div>
        `;
      }).join('');
    }

    function openBookmarkUrl(url) {
      if (!url || url === '#') return;
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    // ì•ˆì „í•œ ë¬¸ìì—´ ì²˜ë¦¬
    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
    function escapeQuotes(str) {
      return String(str ?? '').replaceAll("'", "\\'").replaceAll('"', '\\"');
    }

    // ==================== Bookmarks: DnD ====================
    function onBookmarkDragStart(e, bookmarkId) {
      try {
        e.dataTransfer.setData('text/plain', bookmarkId);
        e.dataTransfer.effectAllowed = 'move';
      } catch (err) {}

      const el = e.currentTarget;
      el.classList.add('dragging');
    }

    function onBookmarkDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      // drag-over ì œê±°
      state.bookmarkGroups.forEach(g => {
        const groupEl = document.getElementById(`group_${g.id}`);
        if (groupEl) groupEl.classList.remove('drag-over');
      });
    }

    function onGroupDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const groupEl = findParentGroupEl(e.target);
      if (groupEl) groupEl.classList.add('drag-over');
    }

    function onGroupDragLeave(e, groupId) {
      const groupEl = document.getElementById(`group_${groupId}`);
      if (!groupEl) return;

      // ì‹¤ì œë¡œ ê·¸ë£¹ ë°–ìœ¼ë¡œ ë‚˜ê°”ì„ ë•Œë§Œ ì œê±°(ê¹œë¹¡ì„ ë°©ì§€)
      const rect = groupEl.getBoundingClientRect();
      const x = e.clientX, y = e.clientY;
      const inside = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
      if (!inside) groupEl.classList.remove('drag-over');
    }

    function onGroupDrop(e, targetGroupId) {
      e.preventDefault();
      const bookmarkId = e.dataTransfer.getData('text/plain');
      if (!bookmarkId) return;

      const bm = state.bookmarks.find(b => b.id === bookmarkId);
      if (!bm) return;

      // ê°™ì€ ê·¸ë£¹ì´ë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
      if (bm.groupId === targetGroupId) return;

      bm.groupId = targetGroupId;
      saveState();
      renderBookmarkGroups();
    }

    function findParentGroupEl(node) {
      let cur = node;
      while (cur && cur !== document.body) {
        if (cur.classList && cur.classList.contains('bookmark-group')) return cur;
        cur = cur.parentNode;
      }
      return null;
    }

    // ==================== Bookmarks: CRUD ====================
    function openAddBookmarkModal(preselectGroupId) {
      // ê·¸ë£¹ select ì±„ìš°ê¸°
      const select = document.getElementById('bookmarkGroup');
      select.innerHTML = state.bookmarkGroups.map(g => `
        <option value="${g.id}" ${g.id === (preselectGroupId || 'default') ? 'selected' : ''}>${escapeHtml(g.name)}</option>
      `).join('');

      document.getElementById('bookmarkModal').classList.add('active');
    }

    function addBookmark(e) {
      e.preventDefault();

      const name = document.getElementById('bookmarkName').value.trim();
      const url = document.getElementById('bookmarkUrl').value.trim();
      const icon = (document.getElementById('bookmarkIcon').value || 'ğŸ”—').trim();
      const groupId = document.getElementById('bookmarkGroup').value || 'default';

      state.bookmarks.push({
        id: uid('bm'),
        name,
        url,
        icon,
        groupId
      });

      saveState();
      renderBookmarkGroups();
      closeModal('bookmarkModal');
      e.target.reset();
    }

    function deleteBookmark(e, bookmarkId) {
      e.preventDefault();
      e.stopPropagation();
      if (!confirm('ì´ ë¶ë§ˆí¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const idx = state.bookmarks.findIndex(b => b.id === bookmarkId);
      if (idx > -1) {
        state.bookmarks.splice(idx, 1);
        saveState();
        renderBookmarkGroups();
      }
    }

    function openBookmarkGroupModal() {
      document.getElementById('bookmarkGroupModal').classList.add('active');
      renderBookmarkGroupList();
    }

    function renderBookmarkGroupList() {
      const container = document.getElementById('bookmarkGroupList');
      container.innerHTML = state.bookmarkGroups.map(g => `
        <div style="display:flex; gap:8px; align-items:center; background: var(--bg-secondary); border:1px solid var(--border); padding:10px; border-radius:12px;">
          <div style="flex:1; min-width:0; color: var(--text-primary); font-size:0.92rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ğŸ“ ${escapeHtml(g.name)} <span style="color:var(--text-muted); font-size:0.8rem;">(${state.bookmarks.filter(b => b.groupId === g.id).length})</span>
          </div>
          <button class="mini-btn" type="button" onclick="renameBookmarkGroup('${g.id}')">ì´ë¦„ë³€ê²½</button>
          ${g.id === 'default'
            ? `<button class="mini-btn danger" type="button" disabled style="opacity:.45; cursor:not-allowed;">ì‚­ì œ</button>`
            : `<button class="mini-btn danger" type="button" onclick="deleteBookmarkGroup('${g.id}')">ì‚­ì œ</button>`
          }
        </div>
      `).join('');
    }

    function addBookmarkGroup() {
      const input = document.getElementById('newBookmarkGroupName');
      const name = (input.value || '').trim();
      if (!name) return;

      state.bookmarkGroups.push({ id: uid('g'), name });
      input.value = '';

      saveState();
      renderBookmarkGroupList();
      renderBookmarkGroups();
    }

    function renameBookmarkGroup(groupId) {
      const g = state.bookmarkGroups.find(x => x.id === groupId);
      if (!g) return;

      const next = prompt('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', g.name);
      if (next === null) return;

      const trimmed = next.trim();
      if (!trimmed) return;

      g.name = trimmed;
      saveState();
      // ë‘ í™”ë©´ ë™ì‹œ ë°˜ì˜
      renderBookmarkGroupList();
      renderBookmarkGroups();
    }

    function deleteBookmarkGroup(groupId) {
      if (groupId === 'default') return;

      const group = state.bookmarkGroups.find(g => g.id === groupId);
      const groupName = group ? group.name : 'ì´ ê·¸ë£¹';

      if (!confirm(`${groupName}ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?\nê·¸ë£¹ ì•ˆì˜ ë¶ë§ˆí¬ëŠ” "ê¸°ë³¸" ê·¸ë£¹ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.`)) return;

      // ê·¸ë£¹ ë¶ë§ˆí¬ -> default ì´ë™
      state.bookmarks = state.bookmarks.map(b => b.groupId === groupId ? { ...b, groupId: 'default' } : b);
      // ê·¸ë£¹ ì‚­ì œ
      state.bookmarkGroups = state.bookmarkGroups.filter(g => g.id !== groupId);

      saveState();
      renderBookmarkGroupList();
      renderBookmarkGroups();
    }

    // ==================== Calendar (Weekly) ====================
    function renderWeeklyCalendar() {
      const grid = document.getElementById('weekGrid');
      const weekLabel = document.getElementById('calendarWeekLabel');
      const weekStart = state.currentWeekStart;
      const todayStr = getLocalDateStr(new Date());

      const month = weekStart.getMonth() + 1;
      const weekOfMonth = Math.ceil((weekStart.getDate() + weekStart.getDay()) / 7);
      weekLabel.textContent = `${weekStart.getFullYear()}ë…„ ${month}ì›” ${weekOfMonth}ì£¼ì°¨`;

      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      let html = '';

      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(date.getDate() + i);
        const dateStr = getLocalDateStr(date);

        const isToday = dateStr === todayStr;
        const isSelected = dateStr === state.selectedDate;

        const localEvents = state.events.filter(e => e.date === dateStr);
        const googleEvts = state.googleEvents.filter(e => e.date === dateStr);
        const allEvents = [...localEvents, ...googleEvts];

        let classes = 'week-day';
        if (isToday) classes += ' today';
        if (isSelected && !isToday) classes += ' selected';

        const dots = allEvents.slice(0, 3).map(() => '<span class="event-dot"></span>').join('');

        html += `
          <div class="${classes}" onclick="selectDate('${dateStr}')">
            <div class="week-day-name">${dayNames[i]}</div>
            <div class="week-day-num">${date.getDate()}</div>
            <div class="week-day-dots">${dots}</div>
          </div>
        `;
      }

      grid.innerHTML = html;
      renderEventsForDate(state.selectedDate);
    }

    function changeWeek(delta) {
      state.currentWeekStart.setDate(state.currentWeekStart.getDate() + (delta * 7));
      renderWeeklyCalendar();
      if (state.googleConnected) fetchGoogleCalendarEvents();
    }

    function goToToday() {
      state.currentWeekStart = getWeekStart(new Date());
      state.selectedDate = getLocalDateStr(new Date());
      renderWeeklyCalendar();
      if (state.googleConnected) fetchGoogleCalendarEvents();
    }

    function selectDate(dateStr) {
      state.selectedDate = dateStr;
      renderWeeklyCalendar();
    }

    function renderEventsForDate(dateStr) {
      const list = document.getElementById('eventsList');
      const header = document.getElementById('selectedDateHeader');

      const date = parseLocalDate(dateStr);
      header.textContent = date.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'long' });

      const localEvents = state.events.filter(e => e.date === dateStr).map(e => ({ ...e, source: 'local' }));
      const googleEvts = state.googleEvents.filter(e => e.date === dateStr).map(e => ({ ...e, source: 'google' }));
      const allEvents = [...localEvents, ...googleEvts].sort((a, b) => (a.time || '').localeCompare(b.time || ''));

      if (allEvents.length === 0) {
        list.innerHTML = '<div class="event-empty">ì´ ë‚ ì˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      list.innerHTML = allEvents.map((e) => {
        const isGoogle = e.source === 'google';
        const timeDisplay = e.time || 'ì¢…ì¼';
        return `
          <div class="event-item ${isGoogle ? 'google-event' : ''}">
            <div class="event-time">${timeDisplay}</div>
            <div class="event-title">${escapeHtml(e.title)}</div>
            ${isGoogle
              ? '<span class="event-source">Google</span>'
              : `<button class="card-btn" onclick="deleteEvent('${e.date}', '${escapeQuotes(e.title)}', '${e.time || ''}')" style="padding:3px 6px;font-size:0.7rem;">ì‚­ì œ</button>`
            }
          </div>
        `;
      }).join('');
    }

    function openAddEventModal() {
      document.getElementById('eventModal').classList.add('active');
      document.getElementById('eventDate').value = state.selectedDate;
    }

    function addEvent(e) {
      e.preventDefault();
      state.events.push({
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value
      });
      saveState();
      renderWeeklyCalendar();
      closeModal('eventModal');
      e.target.reset();
    }

    function deleteEvent(date, title, time) {
      const idx = state.events.findIndex(e => e.date === date && e.title === title && (e.time || '') === time);
      if (idx > -1) {
        state.events.splice(idx, 1);
        saveState();
        renderWeeklyCalendar();
      }
    }

    // ==================== Google Calendar ====================
    function updateGoogleStatus() {
      const statusEl = document.getElementById('googleStatus');
      const textEl = document.getElementById('googleStatusText');
      const btnEl = document.getElementById('googleBtn');
      const selectBtnEl = document.getElementById('googleCalendarSelectBtn');

      if (state.googleConnected) {
        statusEl.classList.remove('disconnected');
        statusEl.classList.add('connected');
        textEl.textContent = 'Google ìº˜ë¦°ë” ì—°ê²°ë¨';
        btnEl.textContent = 'ì—°ê²° í•´ì œ';
        btnEl.classList.add('disconnect');
        selectBtnEl.style.display = 'inline-block';
      } else {
        statusEl.classList.remove('connected');
        statusEl.classList.add('disconnected');
        textEl.textContent = 'Google ìº˜ë¦°ë” ì—°ê²° ì•ˆë¨';
        btnEl.textContent = 'ì—°ê²°';
        btnEl.classList.remove('disconnect');
        selectBtnEl.style.display = 'none';
      }
    }

    function handleGoogleAuth() {
      if (state.googleConnected) {
        state.googleConnected = false;
        state.googleAccessToken = null;
        state.googleEvents = [];
        localStorage.removeItem('googleAccessToken');
        updateGoogleStatus();
        renderWeeklyCalendar();
        return;
      }

      const redirectUri = window.location.origin + window.location.pathname;
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(GOOGLE_SCOPES)}&prompt=consent`;
      window.location.href = authUrl;
    }

    function handleOAuthCallback() {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token')) {
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get('access_token');
        if (accessToken) {
          state.googleAccessToken = accessToken;
          state.googleConnected = true;
          localStorage.setItem('googleAccessToken', accessToken);
          window.history.replaceState({}, document.title, window.location.pathname);
          updateGoogleStatus();
          fetchGoogleCalendarList();
          fetchGoogleCalendarEvents();
        }
      }
    }

    async function fetchGoogleCalendarList() {
      if (!state.googleAccessToken) return;
      try {
        const res = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {
          headers: { 'Authorization': `Bearer ${state.googleAccessToken}` }
        });

        if (res.ok) {
          const data = await res.json();
          state.googleCalendars = data.items || [];

          if (state.selectedCalendars.length === 0) {
            state.selectedCalendars = state.googleCalendars.map(c => c.id);
            saveState();
          }
        }
      } catch (e) {
        console.error('Calendar list error:', e);
      }
    }

    async function openCalendarSelectModal() {
      document.getElementById('calendarSelectModal').classList.add('active');
      if (state.googleCalendars.length === 0) await fetchGoogleCalendarList();
      renderCalendarList();
    }

    function renderCalendarList() {
      const list = document.getElementById('calendarList');

      if (state.googleCalendars.length === 0) {
        list.innerHTML = '<div class="news-loading">ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      list.innerHTML = state.googleCalendars.map(cal => {
        const isChecked = state.selectedCalendars.includes(cal.id);
        const bgColor = cal.backgroundColor || '#4285f4';
        return `
          <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; cursor: pointer;">
            <input type="checkbox" value="${cal.id}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: ${bgColor};">
            <span style="width: 12px; height: 12px; background: ${bgColor}; border-radius: 3px;"></span>
            <span style="flex: 1; color: var(--text-primary);">${escapeHtml(cal.summary)}</span>
          </label>
        `;
      }).join('');
    }

    function saveCalendarSelection() {
      const checkboxes = document.querySelectorAll('#calendarList input[type="checkbox"]');
      state.selectedCalendars = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
      saveState();
      closeModal('calendarSelectModal');
      fetchGoogleCalendarEvents();
    }

    async function fetchGoogleCalendarEvents() {
      if (!state.googleAccessToken) return;
      try {
        const weekStart = new Date(state.currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 7);

        const calendarsToFetch = state.selectedCalendars.length > 0 ? state.selectedCalendars : ['primary'];
        let allEvents = [];

        for (const calendarId of calendarsToFetch) {
          try {
            const res = await fetch(
              `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?timeMin=${encodeURIComponent(weekStart.toISOString())}&timeMax=${encodeURIComponent(weekEnd.toISOString())}&singleEvents=true&orderBy=startTime`,
              { headers: { 'Authorization': `Bearer ${state.googleAccessToken}` } }
            );

            if (res.status === 401) {
              state.googleConnected = false;
              state.googleAccessToken = null;
              localStorage.removeItem('googleAccessToken');
              updateGoogleStatus();
              alert('Google ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.');
              return;
            }

            if (res.ok) {
              const data = await res.json();
              if (data.items) {
                const events = data.items.map(event => {
                  const start = event.start.dateTime || event.start.date;
                  let date, time;
                  if (event.start.dateTime) {
                    const d = new Date(start);
                    date = getLocalDateStr(d);
                    time = d.toTimeString().slice(0, 5);
                  } else {
                    date = start;
                    time = null;
                  }
                  return { id: event.id, title: event.summary || '(ì œëª© ì—†ìŒ)', date, time, calendarId };
                });
                allEvents = allEvents.concat(events);
              }
            }
          } catch (e) {
            console.error(`Calendar ${calendarId} error:`, e);
          }
        }

        state.googleEvents = allEvents;
        renderWeeklyCalendar();
      } catch (e) {
        console.error('Google Calendar error:', e);
      }
    }

    // ==================== Memos ====================
    function renderMemos() {
      const grid = document.getElementById('memoGrid');

      let html = state.memos.map((m, i) => `
        <div class="memo-postit ${m.color || 'yellow'}" onclick="openEditMemo(${i})">
          <button class="memo-postit-delete" onclick="deleteMemo(event, ${i})">Ã—</button>
          <div class="memo-postit-header">
            <div class="memo-postit-title">${escapeHtml(m.title)}</div>
          </div>
          <div class="memo-postit-content">${escapeHtml(m.content || '')}</div>
          <div class="memo-postit-date">${escapeHtml(m.date || '')}</div>
        </div>
      `).join('');

      html += `<div class="memo-postit memo-postit-add" onclick="openAddMemo()">+</div>`;
      grid.innerHTML = html;
    }

    function openAddMemo() {
      document.getElementById('memoModalTitle').textContent = 'ë©”ëª¨ ì¶”ê°€';
      document.getElementById('memoEditIndex').value = '-1';
      document.getElementById('memoTitle').value = '';
      document.getElementById('memoContent').value = '';
      selectColor('yellow');
      document.getElementById('memoModal').classList.add('active');
    }

    function openEditMemo(index) {
      const memo = state.memos[index];
      document.getElementById('memoModalTitle').textContent = 'ë©”ëª¨ ìˆ˜ì •';
      document.getElementById('memoEditIndex').value = index;
      document.getElementById('memoTitle').value = memo.title;
      document.getElementById('memoContent').value = memo.content;
      selectColor(memo.color || 'yellow');
      document.getElementById('memoModal').classList.add('active');
    }

    function selectColor(color) {
      state.selectedMemoColor = color;
      document.querySelectorAll('.color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === color);
      });
    }

    function saveMemo(e) {
      e.preventDefault();
      const index = parseInt(document.getElementById('memoEditIndex').value);
      const dateStr = getLocalDateStr(new Date());

      const memo = {
        title: document.getElementById('memoTitle').value,
        content: document.getElementById('memoContent').value,
        color: state.selectedMemoColor,
        date: dateStr
      };

      if (index === -1) state.memos.push(memo);
      else state.memos[index] = memo;

      saveState();
      renderMemos();
      closeModal('memoModal');
    }

    function deleteMemo(e, index) {
      e.stopPropagation();
      if (confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.memos.splice(index, 1);
        saveState();
        renderMemos();
      }
    }

    function exportAllMemos() {
      if (state.memos.length === 0) {
        alert('ë‚´ë³´ë‚¼ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const wsData = [['ì œëª©', 'ë‚´ìš©', 'ìƒ‰ìƒ', 'ì‘ì„±ì¼']];
      state.memos.forEach(m => wsData.push([m.title, m.content, m.color, m.date]));

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ë©”ëª¨');

      const filename = `memos_${getLocalDateStr(new Date())}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    // ==================== News ====================
    function renderNewsKeywords() {
      const container = document.getElementById('newsKeywords');
      container.innerHTML = state.newsKeywords.map(k => `
        <div class="news-keyword ${k === state.activeKeyword ? 'active' : ''}" onclick="selectKeyword('${escapeQuotes(k)}')">${escapeHtml(k)}</div>
      `).join('');
    }

    function selectKeyword(keyword) {
      state.activeKeyword = keyword;
      renderNewsKeywords();
      loadNews();
    }

    function openKeywordModal() {
      document.getElementById('keywordModal').classList.add('active');
      renderKeywordList();
    }

    function renderKeywordList() {
      document.getElementById('keywordList').innerHTML = state.newsKeywords.map(k => `
        <span class="news-keyword" onclick="deleteKeyword('${escapeQuotes(k)}')" style="cursor:pointer;">${escapeHtml(k)} Ã—</span>
      `).join('');
    }

    function addKeyword(e) {
      e.preventDefault();
      const keyword = document.getElementById('newKeyword').value.trim();
      if (keyword && !state.newsKeywords.includes(keyword)) {
        state.newsKeywords.push(keyword);
        state.activeKeyword = keyword;
        saveState();
        renderNewsKeywords();
        renderKeywordList();
        loadNews();
      }
      document.getElementById('newKeyword').value = '';
    }

    function deleteKeyword(keyword) {
      if (state.newsKeywords.length > 1) {
        state.newsKeywords = state.newsKeywords.filter(k => k !== keyword);
        if (state.activeKeyword === keyword) state.activeKeyword = state.newsKeywords[0];
        saveState();
        renderNewsKeywords();
        renderKeywordList();
        loadNews();
      }
    }

    async function loadNews() {
      const list = document.getElementById('newsList');
      list.innerHTML = '<div class="news-loading">ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

      try {
        const res = await fetch('news.json');
        const allNewsData = await res.json();

        if (allNewsData[state.activeKeyword]) renderNewsItems(allNewsData[state.activeKeyword]);
        else list.innerHTML = `<div class="news-loading">'${escapeHtml(state.activeKeyword)}'ì— ëŒ€í•œ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>ë‹¤ìŒ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</small></div>`;
      } catch (e) {
        list.innerHTML = '<div class="news-loading">ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    }

    function renderNewsItems(items) {
      const list = document.getElementById('newsList');

      // âœ… 7ì¤„ë§Œ í‘œì‹œ
      const displayItems = (items || []).slice(0, 7);

      if (displayItems.length === 0) {
        list.innerHTML = '<div class="news-loading">í‘œì‹œí•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      list.innerHTML = displayItems.map(item => {
        const pubDate = new Date(item.pubDate);
        const timeAgo = getTimeAgo(pubDate);
        const cleanTitle = (item.title || '').replace(/<[^>]*>/g, '').replace(/&quot;/g, '"').replace(/&amp;/g, '&');

        return `
          <a href="${escapeHtml(item.link || '#')}" target="_blank" class="news-item">
            <span class="news-title">${escapeHtml(cleanTitle)}</span>
            <span class="news-time">${escapeHtml(timeAgo)}</span>
          </a>
        `;
      }).join('');
    }

    function getTimeAgo(date) {
      const diff = new Date() - date;
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (mins < 1) return 'ë°©ê¸ˆ';
      if (mins < 60) return mins + 'ë¶„ ì „';
      if (hrs < 24) return hrs + 'ì‹œê°„ ì „';
      return days + 'ì¼ ì „';
    }

    function refreshNews() { loadNews(); }

    // ==================== Modal ====================
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    });

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); });
    });

    // ==================== Start ====================
    init();
  </script>
</body>
</html>
