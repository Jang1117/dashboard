<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Jang's Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-card: #222222;
      --bg-hover: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;
      --accent: #4ecdc4;
      --accent-hover: #45b7aa;
      --border: #333333;
      --success: #4ade80;
      --warning: #fbbf24;
      --danger: #f87171;
      --memo-yellow: #fef3c7;
      --memo-pink: #fce7f3;
      --memo-blue: #dbeafe;
      --memo-green: #d1fae5;
      --memo-purple: #ede9fe;
      --google-blue: #4285f4;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
    }

    /* Header */
    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 12px 30px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    .header-left { display:flex; align-items:center; gap:20px; }
    .header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--accent);
    }
    .header-right { display:flex; align-items:center; gap: 24px; }
    .current-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    /* Weather */
    .weather-inline {
      display:flex;
      align-items:center;
      gap: 12px;
      background: var(--bg-card);
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .weather-icon { font-size: 1.5rem; }
    .weather-temp { font-size: 1.2rem; font-weight: 600; }
    .weather-desc { font-size: 0.85rem; color: var(--text-secondary); }
    .weather-location { font-size: 0.75rem; color: var(--text-muted); }

    /* Layout */
    .main-container {
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 16px;
      padding: 16px 30px;
      max-width: 1600px;
      margin: 0 auto;
      height: calc(100vh - 70px);
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      transition: all 0.3s ease;
      overflow: hidden;
      display:flex;
      flex-direction:column;
    }
    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 30px rgba(78, 205, 196, 0.1);
    }
    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink:0;
    }
    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .card-title-icon { color: var(--accent); }
    .card-actions { display:flex; gap: 6px; align-items:center; }
    .card-btn {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 5px 10px;
      border-radius: 6px;
      cursor:pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .card-btn:hover {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    /* ===== Bookmarks (Grouped) ===== */
    .bookmarks-wrap {
      flex: 1;
      overflow-y: auto;
      padding: 10px 6px 10px 6px; /* ìœ„ìª½ ì—¬ìœ  */
    }

    .group-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--bg-secondary);
      padding: 10px;
      margin-bottom: 10px;
    }

    .group-row {
      display:flex;
      align-items:flex-start;
      gap: 10px;
    }

    /* âœ… ì˜¤ë²„í”Œë¡œìš° í•µì‹¬ í•´ê²° */
    .group-row { min-width: 0; }          /* flex ì»¨í…Œì´ë„ˆì—ì„œ ìì‹ ìˆ˜ì¶• í—ˆìš© */
    .group-sites { min-width: 0; }        /* flex childê°€ ì¤„ì–´ë“¤ ìˆ˜ ìˆê²Œ */
    
    /* í˜¹ì‹œ ëª¨ë¥¼ ê°€ë¡œ ì‚ì ¸ë‚˜ì˜´ ìµœí›„ ë°©ì–´ */
    .bookmarks-wrap { overflow-x: hidden; }
    
    .group-name {
      flex: 0 0 80px;
      max-width: 80px;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.85rem;
      padding-top: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;

      display:flex;
      align-items:center;
      gap: 6px;
    }

    .group-handle {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: grab;
      flex: 0 0 auto;
    }
    .group-handle:active { cursor: grabbing; }

    /* âœ… ê·¸ë£¹ ë‚´ ì‚¬ì´íŠ¸: 4ì»¬ëŸ¼ GRID - minmax(0, 1fr)ë¡œ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
    .group-sites {
      flex: 1;
      min-width: 0;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      align-content: start;
      padding-top: 2px;
    }

    .site-item {
      width: 100%;
      min-width: 0;
      height: 42px;
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor:pointer;
      transition: all 0.2s;
      text-decoration:none;
      color: var(--text-primary);
      position: relative;
      user-select: none;
    }

    .site-item:hover {
      background: var(--bg-hover);
      transform: translateY(-2px);
      border-color: var(--accent);
    }

    .site-icon {
      width: 24px;
      height: 24px;
      min-width: 24px;
      background: var(--bg-hover);
      border-radius: 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 0.9rem;
    }

    .site-name {
      font-size: 0.75rem;
      text-align:left;
      color: var(--text-secondary);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    .site-delete {
      position:absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      background: var(--danger);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 11px;
      cursor: pointer;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 5;
    }
    .site-edit {
      position:absolute;
      top: 4px;
      right: 26px;
      width: 18px;
      height: 18px;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border);
      border-radius: 50%;
      color: var(--text-secondary);
      font-size: 10px;
      cursor:pointer;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 5;
    }
    .site-item:hover .site-delete,
    .site-item:hover .site-edit {
      display:flex;
    }
    .site-edit:hover {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    /* Drop indicator */
    .site-item.drop-before { outline: 2px dashed var(--accent); outline-offset: -2px; }
    .site-item.drop-after  { outline: 2px dashed var(--accent); outline-offset: -2px; }
    .group-box.drop-over   { border-color: var(--accent); }

    .group-box.drop-top    { outline: 2px dashed var(--accent); outline-offset: -2px; }
    .group-box.drop-bottom { outline: 2px dashed var(--accent); outline-offset: -2px; }

    /* ===== Calendar ===== */
    .calendar-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 8px;
    }
    .calendar-nav { display:flex; gap: 6px; }
    .calendar-nav button {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 6px;
      cursor:pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    .calendar-nav button:hover {
      background: var(--accent);
      color: var(--bg-primary);
    }
    .calendar-week-label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    .week-grid {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 10px;
    }
    .week-day {
      text-align:center;
      padding: 8px 4px;
      background: var(--bg-secondary);
      border-radius: 6px;
      cursor:pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .week-day:hover { background: var(--bg-hover); }
    .week-day.today { background: var(--accent); color: var(--bg-primary); }
    .week-day.today .week-day-name { color: var(--bg-primary); }
    .week-day.selected { border-color: var(--accent); background: rgba(78, 205, 196, 0.15); }
    .week-day-name { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2px; }
    .week-day-num { font-size: 1rem; font-weight: 600; }
    .week-day-dots {
      display:flex;
      justify-content:center;
      gap: 2px;
      margin-top: 4px;
      min-height: 5px;
    }
    .event-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); }
    .week-day.today .event-dot { background: var(--bg-primary); }

    .events-date-header {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }
    .events-list {
      height: 88px;
      min-height: 88px;
      max-height: 88px;
      overflow-y:auto;
    }
    .event-item {
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-secondary);
      border-radius: 6px;
      margin-bottom: 4px;
      border-left: 3px solid var(--accent);
      font-size: 0.85rem;
    }
    .event-item.google-event { border-left-color: var(--google-blue); }
    .event-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--accent);
      min-width: 80px;
    }
    .event-item.google-event .event-time { color: var(--google-blue); }
    .event-title { flex: 1; }
    .event-source {
      font-size: 0.65rem;
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 2px 5px;
      border-radius: 3px;
    }
    .event-empty {
      text-align:center;
      color: var(--text-muted);
      padding: 30px 16px;
      font-size: 0.85rem;
    }

    .chip {
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 5px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-hover);
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    .chip.good { border-color: rgba(66,133,244,0.6); color: rgba(66,133,244,1); }

    /* ===== Memo ===== */
    .memo-container { min-height: 200px; max-height: 200px; }
    .memo-grid {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-height: 200px;
      overflow-y:auto;
      padding: 4px;
    }
    .memo-postit {
      background: var(--memo-yellow);
      border-radius: 4px;
      padding: 10px;
      min-height: 90px;
      max-height: 90px;
      cursor:pointer;
      transition: all 0.2s;
      position: relative;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .memo-postit:hover {
      transform: translateY(-3px) rotate(1deg);
      box-shadow: 4px 4px 12px rgba(0,0,0,0.4);
    }
    .memo-postit.yellow { background: var(--memo-yellow); }
    .memo-postit.pink { background: var(--memo-pink); }
    .memo-postit.blue { background: var(--memo-blue); }
    .memo-postit.green { background: var(--memo-green); }
    .memo-postit.purple { background: var(--memo-purple); }

    .memo-postit-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 8px; }
    .memo-postit-title { font-size: 0.8rem; font-weight: 600; color:#333; flex:1; word-break:break-word; }
    .memo-postit-date { font-size: 0.65rem; color:#666; }
    .memo-postit-content {
      font-size: 0.7rem;
      color:#444;
      flex:1;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.3;
      word-break: break-word;
    }
    .memo-postit-delete {
      position:absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      background: rgba(0,0,0,0.3);
      border:none;
      border-radius: 50%;
      color:white;
      font-size: 10px;
      cursor:pointer;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .memo-postit:hover .memo-postit-delete { display:flex; }
    .memo-postit-add {
      background: var(--bg-secondary);
      border: 2px dashed var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--text-muted);
      font-size: 2rem;
    }
    .memo-postit-add:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform:none;
      box-shadow:none;
    }

    /* ===== News ===== */
    .news-keyword-bar { display:flex; gap: 5px; margin-bottom: 8px; flex-wrap:wrap; }
    .news-keyword {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      cursor:pointer;
      transition: all 0.2s;
    }
    .news-keyword:hover,
    .news-keyword.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }
    .news-list { max-height: 294px; overflow-y:auto; }
    .news-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-secondary);
      border-radius: 5px;
      margin-bottom: 4px;
      text-decoration:none;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .news-item:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
    }
    .news-title {
      color: var(--text-primary);
      font-size: 0.78rem;
      line-height: 1.3;
      flex: 1;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .news-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .news-loading {
      text-align:center;
      padding: 30px;
      color: var(--text-muted);
      font-size: 0.85rem;
      line-height: 1.6;
    }

    /* Modal */
    .modal-overlay {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal-overlay.active { display:flex; }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 520px;
      max-height: 80vh;
      overflow-y:auto;
      position: relative;
    }
    .modal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 20px;
      gap: 12px;
    }
    .modal-title { font-size: 1.1rem; font-weight: 600; }
    .modal-close {
      background:none;
      border:none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor:pointer;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 10px;
    }
    .modal-close:hover {
      color: var(--text-primary);
      background: rgba(255,255,255,0.06);
    }

    .form-group { margin-bottom: 16px; }
    .form-label { display:block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85rem; }
    .form-input, .form-textarea, .form-select {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .form-textarea { min-height: 120px; resize: vertical; }
    .form-input:focus, .form-textarea:focus, .form-select:focus { outline:none; border-color: var(--accent); }

    .form-color-options { display:flex; gap: 8px; }
    .color-option {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor:pointer;
      transition: all 0.2s;
    }
    .color-option:hover, .color-option.selected { transform: scale(1.1); border-color: var(--text-primary); }
    .color-option.yellow { background: var(--memo-yellow); }
    .color-option.pink { background: var(--memo-pink); }
    .color-option.blue { background: var(--memo-blue); }
    .color-option.green { background: var(--memo-green); }
    .color-option.purple { background: var(--memo-purple); }

    .form-submit {
      width: 100%;
      background: var(--accent);
      border:none;
      color: var(--bg-primary);
      padding: 12px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor:pointer;
      transition: background 0.2s;
    }
    .form-submit:hover { background: var(--accent-hover); }

    /* Settings Dropdown */
    .settings-dropdown { position:relative; }
    .settings-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 8px 14px;
      border-radius: 8px;
      cursor:pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .settings-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

    .settings-menu {
      display:none;
      position:absolute;
      top:100%;
      right:0;
      margin-top: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      min-width: 180px;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .settings-menu.active { display:block; }
    .settings-menu button {
      display:block;
      width: 100%;
      background:none;
      border:none;
      color: var(--text-secondary);
      padding: 10px 12px;
      text-align:left;
      cursor:pointer;
      border-radius: 6px;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .settings-menu button:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Helper */
    .row { display:flex; gap: 10px; align-items:center; }
    .grow { flex: 1; }
    .muted { color: var(--text-muted); font-size: 0.8rem; }
    .danger-btn { background: rgba(248,113,113,0.12); border: 1px solid rgba(248,113,113,0.4); color: rgba(248,113,113,1); }
    .danger-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <h1>Jang's Dashboard</h1>
    </div>

    <div class="header-right">
      <div class="weather-inline" id="weatherWidget">
        <span class="weather-icon" id="weatherIcon">ğŸŒ¡ï¸</span>
        <div>
          <span class="weather-temp" id="weatherTemp">--Â°</span>
          <span class="weather-desc" id="weatherDesc">ë¡œë”©ì¤‘...</span>
        </div>
        <span class="weather-location" id="weatherLocation">ğŸ“ --</span>
      </div>

      <div class="current-time" id="currentTime">00:00:00</div>

      <div class="settings-dropdown">
        <button class="settings-btn" onclick="toggleSettingsMenu()">âš™ï¸ ì„¤ì •</button>
        <div class="settings-menu" id="settingsMenu">
          <button onclick="exportToJson()">ğŸ“¥ JSON ë‚´ë³´ë‚´ê¸°</button>
          <button onclick="document.getElementById('jsonFileInput').click()">ğŸ“¤ JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="importFromJson(event)" />
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main-container">
    <!-- Bookmarks -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="card-title-icon">â­</span>
          ì¦ê²¨ì°¾ëŠ” ì‚¬ì´íŠ¸
        </div>
        <div class="card-actions">
          <button class="card-btn" onclick="openGroupManageModal()">ê·¸ë£¹ê´€ë¦¬</button>
          <button class="card-btn" onclick="openAddBookmarkModal()">ì‚¬ì´íŠ¸ ì¶”ê°€</button>
        </div>
      </div>
      <div class="bookmarks-wrap" id="bookmarksWrap"></div>
    </div>

    <!-- Calendar -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="card-title-icon">ğŸ“…</span>
          ì£¼ê°„ ì¼ì •
        </div>

        <div class="card-actions">
          <span class="chip" id="googleChip">ğŸ“† ë¯¸ì—°ê²°</span>
          <button class="card-btn" id="googleBtn" onclick="handleGoogleAuth()">ì—°ê²°</button>
          <button class="card-btn" id="googleCalendarSelectBtn" onclick="openCalendarSelectModal()" style="display:none;">ìº˜ë¦°ë” ì„ íƒ</button>
          <button class="card-btn" onclick="openAddEventModal()">+ ì¼ì •</button>
        </div>
      </div>

      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="changeWeek(-1)">â—€</button>
          <button onclick="goToToday()">ì˜¤ëŠ˜</button>
          <button onclick="changeWeek(1)">â–¶</button>
        </div>
        <div class="calendar-week-label" id="calendarWeekLabel">--</div>
      </div>

      <div class="week-grid" id="weekGrid"></div>
      <div id="selectedDateHeader" class="events-date-header"></div>
      <div class="events-list" id="eventsList"></div>
    </div>

    <!-- Memo -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="card-title-icon">ğŸ“</span>
          ë©”ëª¨
        </div>
        <div class="card-actions">
          <button class="card-btn" onclick="exportAllMemos()">ë‚´ë³´ë‚´ê¸°</button>
        </div>
      </div>
      <div class="memo-container">
        <div class="memo-grid" id="memoGrid"></div>
      </div>
    </div>

    <!-- News -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="card-title-icon">ğŸ“°</span>
          ë‰´ìŠ¤
        </div>
        <div class="card-actions">
          <button class="card-btn" onclick="openKeywordModal()">í‚¤ì›Œë“œ</button>
          <button class="card-btn" onclick="refreshNews()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      <div class="news-keyword-bar" id="newsKeywords"></div>
      <div class="news-list" id="newsList">
        <div class="news-loading">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>
  </main>

  <!-- ===== Modals ===== -->

  <!-- Add/Edit Bookmark Modal -->
  <div class="modal-overlay" id="bookmarkModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="bookmarkModalTitle">ì‚¬ì´íŠ¸ ì¶”ê°€</div>
        <button class="modal-close" onclick="closeModal('bookmarkModal')">Ã—</button>
      </div>

      <form onsubmit="saveBookmark(event)">
        <input type="hidden" id="bookmarkEditItemId" value="">

        <div class="form-group">
          <label class="form-label">ê·¸ë£¹</label>
          <select class="form-select" id="bookmarkGroupSelect" required></select>
        </div>

        <div class="form-group">
          <label class="form-label">ì‚¬ì´íŠ¸ ì´ë¦„</label>
          <input type="text" class="form-input" id="bookmarkName" placeholder="ì˜ˆ: Google" required />
        </div>

        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="url" class="form-input" id="bookmarkUrl" placeholder="https://..." required />
        </div>

        <div class="form-group">
          <label class="form-label">ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
          <input type="text" class="form-input" id="bookmarkIcon" placeholder="ğŸŒ" maxlength="2" />
        </div>

        <button type="submit" class="form-submit" id="bookmarkSaveBtn">ì €ì¥í•˜ê¸°</button>
      </form>

      <div class="muted" style="margin-top:10px;">
        * ê·¸ë£¹ëª… ë³€ê²½/ì‚­ì œëŠ” <b>ê·¸ë£¹ê´€ë¦¬</b>ì—ì„œë§Œ ê°€ëŠ¥
      </div>
    </div>
  </div>

  <!-- Group Manage Modal -->
  <div class="modal-overlay" id="groupManageModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ê·¸ë£¹ ê´€ë¦¬</div>
        <button class="modal-close" onclick="closeModal('groupManageModal')">Ã—</button>
      </div>

      <form onsubmit="addGroup(event)">
        <div class="form-group">
          <label class="form-label">ìƒˆ ê·¸ë£¹ëª…</label>
          <div class="row">
            <input type="text" class="form-input grow" id="newGroupName" placeholder="ì˜ˆ: ì—…ë¬´" required />
            <button type="submit" class="card-btn">ì¶”ê°€</button>
          </div>
        </div>
      </form>

      <div class="form-group">
        <label class="form-label">í˜„ì¬ ê·¸ë£¹</label>
        <div id="groupManageList"></div>
      </div>

      <div class="muted">
        * ê·¸ë£¹ëª… ë³€ê²½/ì‚­ì œëŠ” ì´ í™”ë©´ì—ì„œë§Œ ê°€ëŠ¥
      </div>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ì¼ì • ì¶”ê°€</div>
        <button class="modal-close" onclick="closeModal('eventModal')">Ã—</button>
      </div>
      <form onsubmit="addEvent(event)">
        <div class="form-group">
          <label class="form-label">ì¼ì • ì œëª©</label>
          <input type="text" class="form-input" id="eventTitle" placeholder="íšŒì˜, ì•½ì† ë“±" required />
        </div>
        <div class="form-group">
          <label class="form-label">ë‚ ì§œ</label>
          <input type="date" class="form-input" id="eventDate" required />
        </div>
        <div class="form-group">
          <label class="form-label">ì‹œê°„</label>
          <input type="time" class="form-input" id="eventTime" />
        </div>
        <button type="submit" class="form-submit">ì¶”ê°€í•˜ê¸°</button>
      </form>
    </div>
  </div>

  <!-- Add/Edit Memo Modal -->
  <div class="modal-overlay" id="memoModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="memoModalTitle">ë©”ëª¨ ì¶”ê°€</div>
        <button class="modal-close" onclick="closeModal('memoModal')">Ã—</button>
      </div>
      <form onsubmit="saveMemo(event)">
        <input type="hidden" id="memoEditIndex" value="-1" />
        <div class="form-group">
          <label class="form-label">ì œëª©</label>
          <input type="text" class="form-input" id="memoTitle" placeholder="ë©”ëª¨ ì œëª©" required />
        </div>
        <div class="form-group">
          <label class="form-label">ë‚´ìš©</label>
          <textarea class="form-textarea" id="memoContent" placeholder="ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ìƒ‰ìƒ</label>
          <div class="form-color-options" id="colorOptions">
            <div class="color-option yellow selected" data-color="yellow" onclick="selectColor('yellow')"></div>
            <div class="color-option pink" data-color="pink" onclick="selectColor('pink')"></div>
            <div class="color-option blue" data-color="blue" onclick="selectColor('blue')"></div>
            <div class="color-option green" data-color="green" onclick="selectColor('green')"></div>
            <div class="color-option purple" data-color="purple" onclick="selectColor('purple')"></div>
          </div>
        </div>
        <button type="submit" class="form-submit">ì €ì¥í•˜ê¸°</button>
      </form>
    </div>
  </div>

  <!-- Keyword Modal -->
  <div class="modal-overlay" id="keywordModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ë‰´ìŠ¤ í‚¤ì›Œë“œ ê´€ë¦¬</div>
        <button class="modal-close" onclick="closeModal('keywordModal')">Ã—</button>
      </div>

      <form onsubmit="addKeyword(event)">
        <div class="form-group">
          <label class="form-label">ìƒˆ í‚¤ì›Œë“œ</label>
          <input type="text" class="form-input" id="newKeyword" placeholder="ì˜ˆ: AI, ì£¼ì‹, ë¶€ë™ì‚°" required />
        </div>
        <button type="submit" class="form-submit">ì¶”ê°€í•˜ê¸°</button>
      </form>

      <div style="margin-top:16px;">
        <label class="form-label">í˜„ì¬ í‚¤ì›Œë“œ (í´ë¦­í•˜ì—¬ ì‚­ì œ)</label>
        <div id="keywordList" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Calendar Select Modal -->
  <div class="modal-overlay" id="calendarSelectModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">í‘œì‹œí•  ìº˜ë¦°ë” ì„ íƒ</div>
        <button class="modal-close" onclick="closeModal('calendarSelectModal')">Ã—</button>
      </div>
      <div id="calendarList" style="max-height:300px;overflow-y:auto;">
        <div class="news-loading">ìº˜ë¦°ë” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
      <button class="form-submit" onclick="saveCalendarSelection()" style="margin-top:16px;">ì €ì¥</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ==================== State ====================
    let state = {
      // âœ… Bookmarks (flat model)
      bookmarks: [],
      bookmarkGroups: [],
      bookmarkOrderMap: {},

      // Calendar
      events: [],
      googleEvents: [],
      googleCalendars: [],
      selectedCalendars: [],
      currentWeekStart: null,
      selectedDate: null,
      googleConnected: false,
      googleAccessToken: null,

      // Memos
      memos: [],
      selectedMemoColor: 'yellow',

      // News
      newsKeywords: ['IT', 'ê²½ì œ', 'ë¶€ë™ì‚°'],
      activeKeyword: 'IT',
      newsItems: [],
    };

    const STORAGE_KEY = 'dashboardState_v5';

    // Google Calendar API
    const GOOGLE_CLIENT_ID = '616051020242-mg4r2ccc0iks3ssqhjuula6f1sr1o0p8.apps.googleusercontent.com';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

    // News request sequencing
    let newsReqSeq = 0;

    // Drag state (site)
    let dragData = {
      dragging: false,
      fromGroupId: null,
      itemId: null,
      overGroupId: null,
      overItemId: null,
      insertPos: 'after' // 'before' | 'after'
    };

    // Drag state (group)
    let groupDrag = {
      dragging: false,
      groupId: null,
      overGroupId: null,
      insertPos: 'after' // 'before' | 'after'
    };

    // ==================== Date Helpers ====================
    function getLocalDateStr(date) {
      const d = date || new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    function parseLocalDate(dateStr) {
      const [year, month, day] = dateStr.split('-').map(Number);
      return new Date(year, month - 1, day);
    }
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // ==================== Init ====================
    function init() {
      state.currentWeekStart = getWeekStart(new Date());
      state.selectedDate = getLocalDateStr(new Date());

      loadState();
      migrateStateIfNeeded();

      handleOAuthCallback();

      updateTime();
      setInterval(updateTime, 1000);

      getWeather();

      ensureDefaultBookmarks();

      renderBookmarks();
      updateGoogleStatus();
      renderWeeklyCalendar();
      renderMemos();
      renderNewsKeywords();
      loadNews();

      if (state.googleConnected) {
        fetchGoogleCalendarList();
        fetchGoogleCalendarEvents();
      }
    }

    // ==================== Local Storage ====================
    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
          state.currentWeekStart = getWeekStart(new Date());
          state.selectedDate = getLocalDateStr(new Date());
        } catch (e) {}
      }

      const googleToken = localStorage.getItem('googleAccessToken');
      if (googleToken) {
        state.googleAccessToken = googleToken;
        state.googleConnected = true;
      }
    }

    function saveState() {
      const toSave = {
        bookmarks: state.bookmarks,
        bookmarkGroups: state.bookmarkGroups,
        bookmarkOrderMap: state.bookmarkOrderMap,

        events: state.events,
        memos: state.memos,
        newsKeywords: state.newsKeywords,
        activeKeyword: state.activeKeyword,
        selectedCalendars: state.selectedCalendars,
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    }

    // ==================== Migration (nested -> flat) ====================
    function migrateStateIfNeeded() {
      // ì˜ˆì „ ë²„ì „: bookmarkGroups[].items í˜•íƒœê°€ ë‚¨ì•„ìˆìœ¼ë©´ flatë¡œ ë³€í™˜
      const hasNestedItems = Array.isArray(state.bookmarkGroups) && state.bookmarkGroups.some(g => Array.isArray(g.items));
      const hasFlat = Array.isArray(state.bookmarks) && state.bookmarks.length > 0;

      if (hasNestedItems && !hasFlat) {
        const bookmarks = [];
        const orderMap = {};

        for (const g of state.bookmarkGroups) {
          const gid = g.id;
          const items = Array.isArray(g.items) ? g.items : [];
          orderMap[gid] = items.map(it => it.id);

          for (const it of items) {
            bookmarks.push({
              id: it.id,
              name: it.name,
              url: it.url,
              icon: it.icon,
              groupId: gid
            });
          }
          delete g.items;
        }

        state.bookmarks = bookmarks;
        state.bookmarkOrderMap = orderMap;
        saveState();
      }

      // flat í•„ë“œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë³´ì •
      if (!Array.isArray(state.bookmarks)) state.bookmarks = [];
      if (!Array.isArray(state.bookmarkGroups)) state.bookmarkGroups = [];
      if (!state.bookmarkOrderMap || typeof state.bookmarkOrderMap !== 'object') state.bookmarkOrderMap = {};
    }

    // ==================== JSON Export/Import ====================
    function toggleSettingsMenu() {
      document.getElementById('settingsMenu').classList.toggle('active');
    }

    document.addEventListener('click', (e) => {
      const dropdown = document.querySelector('.settings-dropdown');
      const menu = document.getElementById('settingsMenu');
      if (dropdown && !dropdown.contains(e.target)) {
        menu.classList.remove('active');
      }
    });

    function exportToJson() {
      const exportData = {
        version: '1.0',
        exportDate: getLocalDateStr(new Date()),

        bookmarks: state.bookmarks,
        bookmarkGroups: state.bookmarkGroups,
        bookmarkOrderMap: state.bookmarkOrderMap,

        events: state.events,
        memos: state.memos,
        newsKeywords: state.newsKeywords,
        activeKeyword: state.activeKeyword,
        selectedCalendars: state.selectedCalendars
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dashboard_backup_${getLocalDateStr(new Date())}.json`;
      a.click();
      URL.revokeObjectURL(url);

      document.getElementById('settingsMenu').classList.remove('active');
      alert('ì„¤ì •ì´ JSON íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function importFromJson(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importData = JSON.parse(e.target.result);

          // âœ… ë¶ë§ˆí¬(flat)
          if (importData.bookmarks) state.bookmarks = importData.bookmarks;
          if (importData.bookmarkGroups) state.bookmarkGroups = importData.bookmarkGroups;
          if (importData.bookmarkOrderMap) state.bookmarkOrderMap = importData.bookmarkOrderMap;

          if (importData.events) state.events = importData.events;
          if (importData.memos) state.memos = importData.memos;
          if (importData.newsKeywords) state.newsKeywords = importData.newsKeywords;
          if (importData.activeKeyword) state.activeKeyword = importData.activeKeyword;
          if (importData.selectedCalendars) state.selectedCalendars = importData.selectedCalendars;

          migrateStateIfNeeded();
          saveState();

          renderBookmarks();
          renderWeeklyCalendar();
          renderMemos();
          renderNewsKeywords();
          loadNews();

          alert('ì„¤ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (err) {
          alert('JSON íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          console.error(err);
        }
      };
      reader.readAsText(file);

      event.target.value = '';
      document.getElementById('settingsMenu').classList.remove('active');
    }

    // ==================== Time ====================
    function updateTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('ko-KR', { hour12: false });
    }

    // ==================== Weather ====================
    async function getWeather() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
          () => fetchWeather(37.5665, 126.9780)
        );
      } else {
        fetchWeather(37.5665, 126.9780);
      }
    }

    async function fetchWeather(lat, lon) {
      try {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`);
        const data = await res.json();

        const temp = Math.round(data.current.temperature_2m);
        const code = data.current.weather_code;

        document.getElementById('weatherTemp').textContent = temp + 'Â°';
        document.getElementById('weatherDesc').textContent = getWeatherDesc(code);
        document.getElementById('weatherIcon').textContent = getWeatherIcon(code);

        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ko`);
        const geoData = await geoRes.json();
        const loc = geoData.address.city || geoData.address.town || geoData.address.district || 'ì•Œ ìˆ˜ ì—†ìŒ';
        document.getElementById('weatherLocation').textContent = 'ğŸ“ ' + loc;
      } catch (e) {
        document.getElementById('weatherDesc').textContent = 'ë‚ ì”¨ ì •ë³´ ì—†ìŒ';
      }
    }

    function getWeatherIcon(code) {
      const icons = { 0:'â˜€ï¸', 1:'ğŸŒ¤ï¸', 2:'â›…', 3:'â˜ï¸', 45:'ğŸŒ«ï¸', 48:'ğŸŒ«ï¸', 51:'ğŸŒ§ï¸', 53:'ğŸŒ§ï¸', 55:'ğŸŒ§ï¸', 61:'ğŸŒ§ï¸', 63:'ğŸŒ§ï¸', 65:'ğŸŒ§ï¸', 71:'ğŸŒ¨ï¸', 73:'ğŸŒ¨ï¸', 75:'ğŸŒ¨ï¸', 80:'ğŸŒ§ï¸', 81:'ğŸŒ§ï¸', 82:'ğŸŒ§ï¸', 95:'â›ˆï¸', 96:'â›ˆï¸', 99:'â›ˆï¸' };
      return icons[code] || 'ğŸŒ¡ï¸';
    }

    function getWeatherDesc(code) {
      const desc = { 0:'ë§‘ìŒ', 1:'ëŒ€ì²´ë¡œ ë§‘ìŒ', 2:'ë¶€ë¶„ì  íë¦¼', 3:'íë¦¼', 45:'ì•ˆê°œ', 48:'ì•ˆê°œ', 51:'ì´ìŠ¬ë¹„', 53:'ì´ìŠ¬ë¹„', 55:'ì´ìŠ¬ë¹„', 61:'ë¹„', 63:'ë¹„', 65:'í­ìš°', 71:'ëˆˆ', 73:'ëˆˆ', 75:'í­ì„¤', 80:'ì†Œë‚˜ê¸°', 81:'ì†Œë‚˜ê¸°', 82:'í­ìš°', 95:'ë‡Œìš°', 96:'ë‡Œìš°', 99:'ë‡Œìš°' };
      return desc[code] || 'ì •ë³´ ì—†ìŒ';
    }

    // ==================== Bookmarks (Flat + Group DnD + Site DnD) ====================
    function uid(prefix='id') {
      return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
    }

    function ensureDefaultBookmarks() {
      // ê·¸ë£¹ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì„¸íŒ… ìƒì„±
      if (!Array.isArray(state.bookmarkGroups) || state.bookmarkGroups.length === 0) {
        state.bookmarkGroups = [
          { id: 'default', name: 'ê¸°ë³¸' },
          { id: uid('g'), name: 'AI' },
          { id: uid('g'), name: 'í”„ë¡œê·¸ë˜ë°' },
        ];
      }

      // bookmarksê°€ ì—†ìœ¼ë©´ ìƒ˜í”Œ ìƒì„±
      if (!Array.isArray(state.bookmarks) || state.bookmarks.length === 0) {
        const ai = state.bookmarkGroups.find(g => g.name === 'AI')?.id || state.bookmarkGroups[0].id;
        const prog = state.bookmarkGroups.find(g => g.name === 'í”„ë¡œê·¸ë˜ë°')?.id || state.bookmarkGroups[0].id;

        state.bookmarks = [
          { id: uid('bm'), name: 'ì§€ë„', url: 'https://map.naver.com/v5/', icon: 'ğŸ“', groupId: 'default' },
          { id: uid('bm'), name: 'ë‚ ì”¨', url: 'https://weather.naver.com/today', icon: 'ğŸŒ¤ï¸', groupId: 'default' },
          { id: uid('bm'), name: 'ChatGPT', url: 'https://chat.openai.com/', icon: 'ğŸ¤–', groupId: ai },
          { id: uid('bm'), name: 'Gemini', url: 'https://gemini.google.com/', icon: 'âœ¨', groupId: ai },
          { id: uid('bm'), name: 'Claude', url: 'https://claude.ai/', icon: 'âœï¸', groupId: ai },
          { id: uid('bm'), name: 'GitHub', url: 'https://github.com/', icon: 'ğŸ“‚', groupId: prog },
        ];
      }

      // order map ë³´ì •
      if (!state.bookmarkOrderMap || typeof state.bookmarkOrderMap !== 'object') {
        state.bookmarkOrderMap = {};
      }
      for (const g of state.bookmarkGroups) {
        if (!Array.isArray(state.bookmarkOrderMap[g.id])) {
          state.bookmarkOrderMap[g.id] = [];
        }
      }

      // orderMapì— ì—†ëŠ” ë¶ë§ˆí¬ëŠ” í•´ë‹¹ ê·¸ë£¹ ë’¤ì— ë¶™ì—¬ì¤Œ
      for (const g of state.bookmarkGroups) {
        const gid = g.id;
        const inGroup = state.bookmarks.filter(b => b.groupId === gid).map(b => b.id);
        const order = state.bookmarkOrderMap[gid] || (state.bookmarkOrderMap[gid] = []);
        const set = new Set(order);
        for (const id of inGroup) {
          if (!set.has(id)) order.push(id);
        }
      }

      saveState();
    }

    function getBookmarksForGroup(groupId) {
      const all = Array.isArray(state.bookmarks) ? state.bookmarks : [];
      const order = (state.bookmarkOrderMap && Array.isArray(state.bookmarkOrderMap[groupId]))
        ? state.bookmarkOrderMap[groupId]
        : [];

      const byId = new Map(all.map(b => [b.id, b]));
      const inGroup = all.filter(b => b.groupId === groupId);

      const ordered = [];
      const used = new Set();

      for (const id of order) {
        const b = byId.get(id);
        if (b && b.groupId === groupId) {
          ordered.push(b);
          used.add(id);
        }
      }
      for (const b of inGroup) {
        if (!used.has(b.id)) ordered.push(b);
      }
      return ordered;
    }

    function renderBookmarks() {
      const wrap = document.getElementById('bookmarksWrap');
      if (!wrap) return;

      const groups = Array.isArray(state.bookmarkGroups) ? state.bookmarkGroups : [];

      wrap.innerHTML = groups.map(g => {
        const items = getBookmarksForGroup(g.id);

        const sites = items.map(item => `
          <a href="${escapeAttr(item.url)}" target="_blank"
             class="site-item"
             draggable="true"
             data-group-id="${escapeAttr(g.id)}"
             data-item-id="${escapeAttr(item.id)}"
             ondragstart="onSiteDragStart(event)"
             ondragend="onSiteDragEnd(event)"
             ondragover="onSiteDragOver(event)"
             ondrop="onSiteDrop(event)"
          >
            <button class="site-delete" title="ì‚­ì œ"
              onclick="deleteSite(event, '${escapeAttr(g.id)}', '${escapeAttr(item.id)}')">Ã—</button>

            <button class="site-edit" title="ì´ë¦„/URL ë³€ê²½"
              onclick="openEditBookmarkModal(event, '${escapeAttr(item.id)}')">âœ</button>

            <div class="site-icon">${escapeHtml(item.icon || 'ğŸ”—')}</div>
            <div class="site-name">${escapeHtml(item.name || '')}</div>
          </a>
        `).join('');

        return `
          <div class="group-box"
               data-group-id="${escapeAttr(g.id)}"
               ondragover="onGroupBoxDragOver(event)"
               ondragleave="onGroupBoxDragLeave(event)"
               ondrop="onGroupBoxDrop(event)"
          >
            <div class="group-row">
              <div class="group-name" title="${escapeAttr(g.name)}">
                <span class="group-handle"
                      title="ê·¸ë£¹ ìˆœì„œ ë³€ê²½"
                      draggable="true"
                      data-group-id="${escapeAttr(g.id)}"
                      ondragstart="onGroupDragStart(event)"
                      ondragend="onGroupDragEnd(event)"
                >â‰¡</span>
                <span>${escapeHtml(g.name)}</span>
              </div>

              <div class="group-sites">
                ${sites}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(str) {
      return String(str || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }
    function escapeAttr(str) { return escapeHtml(str); }

    function openAddBookmarkModal() {
      document.getElementById('bookmarkModalTitle').textContent = 'ì‚¬ì´íŠ¸ ì¶”ê°€';
      document.getElementById('bookmarkSaveBtn').textContent = 'ì¶”ê°€í•˜ê¸°';
      document.getElementById('bookmarkEditItemId').value = '';

      fillGroupSelect(null);
      document.getElementById('bookmarkName').value = '';
      document.getElementById('bookmarkUrl').value = '';
      document.getElementById('bookmarkIcon').value = '';

      document.getElementById('bookmarkModal').classList.add('active');
    }

    function openEditBookmarkModal(e, itemId) {
      e.preventDefault();
      e.stopPropagation();

      const b = state.bookmarks.find(x => x.id === itemId);
      if (!b) return;

      document.getElementById('bookmarkModalTitle').textContent = 'ì‚¬ì´íŠ¸ ìˆ˜ì •';
      document.getElementById('bookmarkSaveBtn').textContent = 'ì €ì¥í•˜ê¸°';
      document.getElementById('bookmarkEditItemId').value = b.id;

      fillGroupSelect(b.groupId);
      document.getElementById('bookmarkName').value = b.name || '';
      document.getElementById('bookmarkUrl').value = b.url || '';
      document.getElementById('bookmarkIcon').value = b.icon || '';

      document.getElementById('bookmarkModal').classList.add('active');
    }

    function fillGroupSelect(selectedGroupId) {
      const sel = document.getElementById('bookmarkGroupSelect');
      sel.innerHTML = state.bookmarkGroups.map(g => `
        <option value="${escapeAttr(g.id)}" ${g.id === selectedGroupId ? 'selected' : ''}>${escapeHtml(g.name)}</option>
      `).join('');
      if (!selectedGroupId && state.bookmarkGroups[0]) {
        sel.value = state.bookmarkGroups[0].id;
      }
    }

    function ensureOrderArray(groupId) {
      if (!state.bookmarkOrderMap[groupId]) state.bookmarkOrderMap[groupId] = [];
      if (!Array.isArray(state.bookmarkOrderMap[groupId])) state.bookmarkOrderMap[groupId] = [];
      return state.bookmarkOrderMap[groupId];
    }

    function removeFromOrderEverywhere(itemId) {
      for (const gid of Object.keys(state.bookmarkOrderMap || {})) {
        const arr = state.bookmarkOrderMap[gid];
        if (!Array.isArray(arr)) continue;
        const i = arr.indexOf(itemId);
        if (i >= 0) arr.splice(i, 1);
      }
    }

    function insertIntoOrder(groupId, itemId, toItemId, insertPos) {
      const arr = ensureOrderArray(groupId);

      // ì´ë¯¸ ìˆìœ¼ë©´ ì œê±°
      const existing = arr.indexOf(itemId);
      if (existing >= 0) arr.splice(existing, 1);

      if (!toItemId) {
        arr.push(itemId);
        return;
      }

      let idx = arr.indexOf(toItemId);
      if (idx < 0) {
        arr.push(itemId);
        return;
      }
      if (insertPos === 'after') idx += 1;
      arr.splice(idx, 0, itemId);
    }

    function saveBookmark(e) {
      e.preventDefault();

      const editItemId = document.getElementById('bookmarkEditItemId').value;
      const targetGroupId = document.getElementById('bookmarkGroupSelect').value;
      const name = document.getElementById('bookmarkName').value.trim();
      const url = document.getElementById('bookmarkUrl').value.trim();
      const icon = document.getElementById('bookmarkIcon').value.trim() || 'ğŸ”—';
      if (!name || !url || !targetGroupId) return;

      if (editItemId) {
        const b = state.bookmarks.find(x => x.id === editItemId);
        if (!b) return;

        const fromGroupId = b.groupId;
        b.name = name;
        b.url = url;
        b.icon = icon;

        if (fromGroupId !== targetGroupId) {
          b.groupId = targetGroupId;
          removeFromOrderEverywhere(b.id);
          insertIntoOrder(targetGroupId, b.id, null, 'after');
        }
      } else {
        const newItem = { id: uid('bm'), name, url, icon, groupId: targetGroupId };
        state.bookmarks.push(newItem);
        insertIntoOrder(targetGroupId, newItem.id, null, 'after');
      }

      saveState();
      renderBookmarks();
      closeModal('bookmarkModal');
      e.target.reset();
    }

    function deleteSite(e, groupId, itemId) {
      e.preventDefault();
      e.stopPropagation();
      if (!confirm('ì´ ì‚¬ì´íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      state.bookmarks = state.bookmarks.filter(b => b.id !== itemId);
      removeFromOrderEverywhere(itemId);

      saveState();
      renderBookmarks();
    }

    function openGroupManageModal() {
      renderGroupManageList();
      document.getElementById('groupManageModal').classList.add('active');
    }

    function addGroup(e) {
      e.preventDefault();
      const name = document.getElementById('newGroupName').value.trim();
      if (!name) return;

      const gid = uid('g');
      state.bookmarkGroups.push({ id: gid, name });
      ensureOrderArray(gid);

      document.getElementById('newGroupName').value = '';
      saveState();
      renderGroupManageList();
      renderBookmarks();
    }

    function renderGroupManageList() {
      const el = document.getElementById('groupManageList');
      if (!el) return;

      el.innerHTML = state.bookmarkGroups.map(g => `
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <input class="form-input" style="flex:1;" value="${escapeAttr(g.name)}" data-gid="${escapeAttr(g.id)}"
                 oninput="onGroupNameInput(event)" />
          <button class="card-btn danger-btn" onclick="deleteGroup('${escapeAttr(g.id)}')">ì‚­ì œ</button>
        </div>
      `).join('');

      if (state.bookmarkGroups.length <= 1) {
        const btns = el.querySelectorAll('button.danger-btn');
        btns.forEach(b => b.disabled = true);
      }
    }

    function onGroupNameInput(e) {
      const gid = e.target.dataset.gid;
      const g = state.bookmarkGroups.find(x => x.id === gid);
      if (!g) return;

      g.name = e.target.value;
      saveState();
      renderBookmarks();
    }

    function deleteGroup(groupId) {
      if (state.bookmarkGroups.length <= 1) {
        alert('ìµœì†Œ 1ê°œì˜ ê·¸ë£¹ì€ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }
      if (!confirm('ì´ ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”? (ê·¸ë£¹ ë‚´ ì‚¬ì´íŠ¸ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;

      // ê·¸ë£¹ ë‚´ ë¶ë§ˆí¬ ì‚­ì œ
      const toDelete = state.bookmarks.filter(b => b.groupId === groupId).map(b => b.id);
      state.bookmarks = state.bookmarks.filter(b => b.groupId !== groupId);
      for (const id of toDelete) removeFromOrderEverywhere(id);

      // ê·¸ë£¹ ì‚­ì œ
      state.bookmarkGroups = state.bookmarkGroups.filter(g => g.id !== groupId);
      delete state.bookmarkOrderMap[groupId];

      saveState();
      renderGroupManageList();
      renderBookmarks();
    }

    // ===== Drag & Drop: Site =====
    function onSiteDragStart(e) {
      const a = e.currentTarget;
      dragData.dragging = true;
      dragData.fromGroupId = a.dataset.groupId;
      dragData.itemId = a.dataset.itemId;

      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('application/x-dashboard-site', JSON.stringify({ groupId: dragData.fromGroupId, itemId: dragData.itemId }));
      a.style.opacity = '0.6';
    }

    function onSiteDragEnd(e) {
      const a = e.currentTarget;
      a.style.opacity = '';

      document.querySelectorAll('.site-item').forEach(x => x.classList.remove('drop-before','drop-after'));
      document.querySelectorAll('.group-box').forEach(x => x.classList.remove('drop-over'));

      dragData = { dragging:false, fromGroupId:null, itemId:null, overGroupId:null, overItemId:null, insertPos:'after' };
    }

    // âœ… ì¢Œ/ìš° ë°˜ìœ¼ë¡œ before/after ê²°ì • (ì •í™•ë„ â†‘)
    function onSiteDragOver(e) {
      e.preventDefault();
      if (!dragData.dragging) return;

      const target = e.currentTarget;
      const overGroupId = target.dataset.groupId;
      const overItemId = target.dataset.itemId;

      if (overGroupId === dragData.fromGroupId && overItemId === dragData.itemId) return;

      const rect = target.getBoundingClientRect();
      const midX = rect.left + rect.width / 2;
      const pos = (e.clientX < midX) ? 'before' : 'after';

      dragData.overGroupId = overGroupId;
      dragData.overItemId = overItemId;
      dragData.insertPos = pos;

      document.querySelectorAll('.site-item').forEach(x => x.classList.remove('drop-before','drop-after'));
      target.classList.add(pos === 'before' ? 'drop-before' : 'drop-after');
    }

    function onSiteDrop(e) {
      e.preventDefault();
      if (!dragData.dragging) return;

      const target = e.currentTarget;
      const toGroupId = target.dataset.groupId;
      const toItemId = target.dataset.itemId;

      moveBookmarkItem(dragData.fromGroupId, dragData.itemId, toGroupId, toItemId, dragData.insertPos);
    }

    // ===== Drag & Drop: Group =====
    function onGroupDragStart(e) {
      e.stopPropagation();
      const gid = e.currentTarget.dataset.groupId;
      groupDrag.dragging = true;
      groupDrag.groupId = gid;

      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('application/x-dashboard-group', gid);
    }

    function onGroupDragEnd(e) {
      document.querySelectorAll('.group-box').forEach(x => x.classList.remove('drop-top','drop-bottom'));
      groupDrag = { dragging:false, groupId:null, overGroupId:null, insertPos:'after' };
    }

    // ===== Group Box (drop target): handles both site move & group reorder =====
    function onGroupBoxDragOver(e) {
      e.preventDefault();
      const box = e.currentTarget;

      if (groupDrag.dragging) {
        const toGroupId = box.dataset.groupId;
        if (toGroupId === groupDrag.groupId) return;

        const rect = box.getBoundingClientRect();
        const midY = rect.top + rect.height / 2;
        const pos = (e.clientY < midY) ? 'before' : 'after';

        groupDrag.overGroupId = toGroupId;
        groupDrag.insertPos = pos;

        document.querySelectorAll('.group-box').forEach(x => x.classList.remove('drop-top','drop-bottom'));
        box.classList.add(pos === 'before' ? 'drop-top' : 'drop-bottom');
        return;
      }

      if (dragData.dragging) {
        box.classList.add('drop-over');
      }
    }

    function onGroupBoxDragLeave(e) {
      const box = e.currentTarget;
      box.classList.remove('drop-over');
      box.classList.remove('drop-top','drop-bottom');
    }

    function onGroupBoxDrop(e) {
      e.preventDefault();
      const box = e.currentTarget;
      const toGroupId = box.dataset.groupId;

      box.classList.remove('drop-over');
      box.classList.remove('drop-top','drop-bottom');

      if (groupDrag.dragging) {
        reorderGroups(groupDrag.groupId, toGroupId, groupDrag.insertPos);
        onGroupDragEnd(e);
        return;
      }

      if (dragData.dragging) {
        // ê·¸ë£¹ ë¹ˆ ê³µê°„ì— drop â†’ ë§¨ ë’¤ë¡œ
        moveBookmarkItem(dragData.fromGroupId, dragData.itemId, toGroupId, null, 'after');
      }
    }

    function reorderGroups(fromGroupId, toGroupId, insertPos) {
      if (!fromGroupId || !toGroupId || fromGroupId === toGroupId) return;

      const arr = state.bookmarkGroups;
      const fromIdx = arr.findIndex(g => g.id === fromGroupId);
      const toIdx0 = arr.findIndex(g => g.id === toGroupId);
      if (fromIdx < 0 || toIdx0 < 0) return;

      const [moving] = arr.splice(fromIdx, 1);

      let toIdx = arr.findIndex(g => g.id === toGroupId);
      if (toIdx < 0) toIdx = arr.length;
      if (insertPos === 'after') toIdx += 1;

      arr.splice(toIdx, 0, moving);

      saveState();
      renderBookmarks();
    }

    function moveBookmarkItem(fromGroupId, itemId, toGroupId, toItemId, insertPos) {
      const b = state.bookmarks.find(x => x.id === itemId);
      if (!b) return;

      // groupId ì—…ë°ì´íŠ¸
      b.groupId = toGroupId;

      // orderMap ì—…ë°ì´íŠ¸
      removeFromOrderEverywhere(itemId);

      // drop targetì´ ê°™ì€ ê·¸ë£¹ ë‚´ itemì´ë©´ í•´ë‹¹ group order ê¸°ì¤€ìœ¼ë¡œ insert
      insertIntoOrder(toGroupId, itemId, toItemId, insertPos);

      saveState();
      renderBookmarks();
    }

    // ==================== Calendar ====================
    function renderWeeklyCalendar() {
      const grid = document.getElementById('weekGrid');
      const weekLabel = document.getElementById('calendarWeekLabel');
      const weekStart = state.currentWeekStart;
      const todayStr = getLocalDateStr(new Date());

      const month = weekStart.getMonth() + 1;
      const weekOfMonth = Math.ceil((weekStart.getDate() + weekStart.getDay()) / 7);
      weekLabel.textContent = `${weekStart.getFullYear()}ë…„ ${month}ì›” ${weekOfMonth}ì£¼ì°¨`;

      const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      let html = '';

      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(date.getDate() + i);
        const dateStr = getLocalDateStr(date);

        const isToday = dateStr === todayStr;
        const isSelected = dateStr === state.selectedDate;

        const localEvents = state.events.filter(e => e.date === dateStr);
        const googleEvts = state.googleEvents.filter(e => e.date === dateStr);
        const allEvents = [...localEvents, ...googleEvts];

        let classes = 'week-day';
        if (isToday) classes += ' today';
        if (isSelected && !isToday) classes += ' selected';

        const dots = allEvents.slice(0,3).map(() => '<span class="event-dot"></span>').join('');

        html += `
          <div class="${classes}" onclick="selectDate('${dateStr}')">
            <div class="week-day-name">${dayNames[i]}</div>
            <div class="week-day-num">${date.getDate()}</div>
            <div class="week-day-dots">${dots}</div>
          </div>
        `;
      }

      grid.innerHTML = html;
      renderEventsForDate(state.selectedDate);
    }

    function changeWeek(delta) {
      state.currentWeekStart.setDate(state.currentWeekStart.getDate() + (delta * 7));
      renderWeeklyCalendar();
      if (state.googleConnected) fetchGoogleCalendarEvents();
    }

    function goToToday() {
      state.currentWeekStart = getWeekStart(new Date());
      state.selectedDate = getLocalDateStr(new Date());
      renderWeeklyCalendar();
      if (state.googleConnected) fetchGoogleCalendarEvents();
    }

    function selectDate(dateStr) {
      state.selectedDate = dateStr;
      renderWeeklyCalendar();
    }

    function renderEventsForDate(dateStr) {
      const list = document.getElementById('eventsList');
      const header = document.getElementById('selectedDateHeader');

      const date = parseLocalDate(dateStr);
      header.textContent = date.toLocaleDateString('ko-KR', { month:'long', day:'numeric', weekday:'long' });

      const localEvents = state.events.filter(e => e.date === dateStr).map(e => ({ ...e, source:'local' }));
      const googleEvts = state.googleEvents.filter(e => e.date === dateStr).map(e => ({ ...e, source:'google' }));
      const allEvents = [...localEvents, ...googleEvts].sort((a,b) => (a.time || '').localeCompare(b.time || ''));

      if (allEvents.length === 0) {
        list.innerHTML = '<div class="event-empty">ì´ ë‚ ì˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      list.innerHTML = allEvents.map(e => {
        const isGoogle = e.source === 'google';
        const timeDisplay = e.time || 'ì¢…ì¼';
        return `
          <div class="event-item ${isGoogle ? 'google-event' : ''}">
            <div class="event-time">${timeDisplay}</div>
            <div class="event-title">${escapeHtml(e.title)}</div>
            ${
              isGoogle
                ? '<span class="event-source">Google</span>'
                : `<button class="card-btn" onclick="deleteEvent('${escapeAttr(e.date)}','${escapeAttr(e.title)}','${escapeAttr(e.time || '')}')" style="padding:3px 6px;font-size:0.7rem;">ì‚­ì œ</button>`
            }
          </div>
        `;
      }).join('');
    }

    function openAddEventModal() {
      document.getElementById('eventModal').classList.add('active');
      document.getElementById('eventDate').value = state.selectedDate;
    }

    function addEvent(e) {
      e.preventDefault();
      state.events.push({
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value
      });
      saveState();
      renderWeeklyCalendar();
      closeModal('eventModal');
      e.target.reset();
    }

    function deleteEvent(date, title, time) {
      const idx = state.events.findIndex(e => e.date === date && e.title === title && (e.time || '') === time);
      if (idx > -1) {
        state.events.splice(idx, 1);
        saveState();
        renderWeeklyCalendar();
      }
    }

    // ==================== Google Calendar ====================
    function updateGoogleStatus() {
      const chip = document.getElementById('googleChip');
      const btn = document.getElementById('googleBtn');
      const selectBtn = document.getElementById('googleCalendarSelectBtn');

      if (state.googleConnected) {
        chip.textContent = 'ğŸ“† ì—°ê²°ë¨';
        chip.classList.add('good');
        btn.textContent = 'ì—°ê²° í•´ì œ';
        btn.classList.add('danger-btn');
        selectBtn.style.display = 'inline-block';
      } else {
        chip.textContent = 'ğŸ“† ë¯¸ì—°ê²°';
        chip.classList.remove('good');
        btn.textContent = 'ì—°ê²°';
        btn.classList.remove('danger-btn');
        selectBtn.style.display = 'none';
      }
    }

    function handleGoogleAuth() {
      if (state.googleConnected) {
        state.googleConnected = false;
        state.googleAccessToken = null;
        state.googleEvents = [];
        localStorage.removeItem('googleAccessToken');
        updateGoogleStatus();
        renderWeeklyCalendar();
        return;
      }

      const redirectUri = window.location.origin + window.location.pathname;
      const authUrl =
        `https://accounts.google.com/o/oauth2/v2/auth` +
        `?client_id=${encodeURIComponent(GOOGLE_CLIENT_ID)}` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&response_type=token` +
        `&scope=${encodeURIComponent(GOOGLE_SCOPES)}` +
        `&prompt=consent`;

      window.location.href = authUrl;
    }

    function handleOAuthCallback() {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token')) {
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get('access_token');
        if (accessToken) {
          state.googleAccessToken = accessToken;
          state.googleConnected = true;
          localStorage.setItem('googleAccessToken', accessToken);

          window.history.replaceState({}, document.title, window.location.pathname);
          updateGoogleStatus();
          fetchGoogleCalendarList();
          fetchGoogleCalendarEvents();
        }
      }
    }

    async function fetchGoogleCalendarList() {
      if (!state.googleAccessToken) return;
      try {
        const res = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {
          headers: { 'Authorization': `Bearer ${state.googleAccessToken}` }
        });

        if (res.ok) {
          const data = await res.json();
          state.googleCalendars = data.items || [];

          if (state.selectedCalendars.length === 0) {
            state.selectedCalendars = state.googleCalendars.map(c => c.id);
            saveState();
          }
        }
      } catch (e) {
        console.error('Calendar list error:', e);
      }
    }

    async function openCalendarSelectModal() {
      document.getElementById('calendarSelectModal').classList.add('active');
      if (state.googleCalendars.length === 0) {
        await fetchGoogleCalendarList();
      }
      renderCalendarList();
    }

    function renderCalendarList() {
      const list = document.getElementById('calendarList');

      if (state.googleCalendars.length === 0) {
        list.innerHTML = '<div class="news-loading">ìº˜ë¦°ë”ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }

      list.innerHTML = state.googleCalendars.map(cal => {
        const isChecked = state.selectedCalendars.includes(cal.id);
        const bgColor = cal.backgroundColor || '#4285f4';
        return `
          <label style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;cursor:pointer;">
            <input type="checkbox" value="${escapeAttr(cal.id)}" ${isChecked ? 'checked' : ''} style="width:18px;height:18px;accent-color:${bgColor};">
            <span style="width:12px;height:12px;background:${bgColor};border-radius:3px;"></span>
            <span style="flex:1;color:var(--text-primary);">${escapeHtml(cal.summary)}</span>
          </label>
        `;
      }).join('');
    }

    function saveCalendarSelection() {
      const checkboxes = document.querySelectorAll('#calendarList input[type="checkbox"]');
      state.selectedCalendars = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      saveState();
      closeModal('calendarSelectModal');
      fetchGoogleCalendarEvents();
    }

    async function fetchGoogleCalendarEvents() {
      if (!state.googleAccessToken) return;

      try {
        const weekStart = new Date(state.currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 7);

        const calendarsToFetch = state.selectedCalendars.length > 0 ? state.selectedCalendars : ['primary'];
        let allEvents = [];

        for (const calendarId of calendarsToFetch) {
          try {
            const res = await fetch(
              `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events` +
              `?timeMin=${encodeURIComponent(weekStart.toISOString())}` +
              `&timeMax=${encodeURIComponent(weekEnd.toISOString())}` +
              `&singleEvents=true&orderBy=startTime`,
              { headers: { 'Authorization': `Bearer ${state.googleAccessToken}` } }
            );

            if (res.status === 401) {
              state.googleConnected = false;
              state.googleAccessToken = null;
              localStorage.removeItem('googleAccessToken');
              updateGoogleStatus();
              alert('Google ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ê²°í•´ì£¼ì„¸ìš”.');
              return;
            }

            if (res.ok) {
              const data = await res.json();
              if (data.items) {
                const events = data.items.map(event => {
                  const start = event.start.dateTime || event.start.date;
                  let date, time;

                  if (event.start.dateTime) {
                    const d = new Date(start);
                    date = getLocalDateStr(d);
                    time = d.toTimeString().slice(0, 5);
                  } else {
                    date = start;
                    time = null;
                  }

                  return { id: event.id, title: event.summary || '(ì œëª© ì—†ìŒ)', date, time, calendarId };
                });
                allEvents = allEvents.concat(events);
              }
            }
          } catch (e) {
            console.error(`Calendar ${calendarId} error:`, e);
          }
        }

        state.googleEvents = allEvents;
        renderWeeklyCalendar();
      } catch (e) {
        console.error('Google Calendar error:', e);
      }
    }

    // ==================== Memos ====================
    function renderMemos() {
      const grid = document.getElementById('memoGrid');

      let html = state.memos.map((m, i) => `
        <div class="memo-postit ${escapeAttr(m.color || 'yellow')}" onclick="openEditMemo(${i})">
          <button class="memo-postit-delete" onclick="deleteMemo(event, ${i})">Ã—</button>
          <div class="memo-postit-header">
            <div class="memo-postit-title">${escapeHtml(m.title)}</div>
          </div>
          <div class="memo-postit-content">${escapeHtml(m.content || '')}</div>
          <div class="memo-postit-date">${escapeHtml(m.date || '')}</div>
        </div>
      `).join('');

      html += `<div class="memo-postit memo-postit-add" onclick="openAddMemo()">+</div>`;
      grid.innerHTML = html;
    }

    function openAddMemo() {
      document.getElementById('memoModalTitle').textContent = 'ë©”ëª¨ ì¶”ê°€';
      document.getElementById('memoEditIndex').value = '-1';
      document.getElementById('memoTitle').value = '';
      document.getElementById('memoContent').value = '';
      selectColor('yellow');
      document.getElementById('memoModal').classList.add('active');
    }

    function openEditMemo(index) {
      const memo = state.memos[index];
      document.getElementById('memoModalTitle').textContent = 'ë©”ëª¨ ìˆ˜ì •';
      document.getElementById('memoEditIndex').value = index;
      document.getElementById('memoTitle').value = memo.title;
      document.getElementById('memoContent').value = memo.content;
      selectColor(memo.color || 'yellow');
      document.getElementById('memoModal').classList.add('active');
    }

    function selectColor(color) {
      state.selectedMemoColor = color;
      document.querySelectorAll('.color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === color);
      });
    }

    function saveMemo(e) {
      e.preventDefault();
      const index = parseInt(document.getElementById('memoEditIndex').value, 10);
      const dateStr = getLocalDateStr(new Date());

      const memo = {
        title: document.getElementById('memoTitle').value,
        content: document.getElementById('memoContent').value,
        color: state.selectedMemoColor,
        date: dateStr
      };

      if (index === -1) state.memos.push(memo);
      else state.memos[index] = memo;

      saveState();
      renderMemos();
      closeModal('memoModal');
    }

    function deleteMemo(e, index) {
      e.stopPropagation();
      if (confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        state.memos.splice(index, 1);
        saveState();
        renderMemos();
      }
    }

    function exportAllMemos() {
      if (state.memos.length === 0) {
        alert('ë‚´ë³´ë‚¼ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const wsData = [['ì œëª©', 'ë‚´ìš©', 'ìƒ‰ìƒ', 'ì‘ì„±ì¼']];
      state.memos.forEach(m => wsData.push([m.title, m.content, m.color, m.date]));

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ë©”ëª¨');

      const filename = `memos_${getLocalDateStr(new Date())}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    // ==================== News (Load 21 / Show 7 / Cache-bust) ====================
    function renderNewsKeywords() {
      const container = document.getElementById('newsKeywords');
      container.innerHTML = state.newsKeywords.map(k => `
        <div class="news-keyword ${k === state.activeKeyword ? 'active' : ''}" onclick="selectKeyword('${escapeAttr(k)}')">${escapeHtml(k)}</div>
      `).join('');
    }

    function selectKeyword(keyword) {
      state.activeKeyword = keyword;
      saveState();
      renderNewsKeywords();
      loadNews();
    }

    async function loadNews() {
      const list = document.getElementById('newsList');
      list.innerHTML = '<div class="news-loading">ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</div>';

      const mySeq = ++newsReqSeq;

      try {
        // ìºì‹œ ë²„ìŠ¤íŒ…: íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ê°’
        const cacheBuster = `${Date.now()}_${Math.random().toString(36).slice(2)}`;
        const url = `./news.json?_=${cacheBuster}`;

        const res = await fetch(url, {
          method: 'GET',
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const allNewsData = await res.json();
        if (mySeq !== newsReqSeq) return;

        const raw = allNewsData[state.activeKeyword] || [];
        state.newsItems = raw.slice(0, 21);  // ë¡œë“œ 21ê°œ
        renderNewsItems();
      } catch (e) {
        console.error('loadNews error:', e);
        if (mySeq !== newsReqSeq) return;
        list.innerHTML = '<div class="news-loading">ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    }

    function renderNewsItems() {
      const list = document.getElementById('newsList');
      const display = (state.newsItems || []).slice(0, 7); // í‘œì‹œ 7ê°œ

      if (display.length === 0) {
        list.innerHTML = `<div class="news-loading">'${escapeHtml(state.activeKeyword)}'ì— ëŒ€í•œ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>ë‹¤ìŒ ì—…ë°ì´íŠ¸ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</small></div>`;
        return;
      }

      list.innerHTML = display.map(item => {
        const pubDate = new Date(item.pubDate);
        const timeAgo = getTimeAgo(pubDate);
        const cleanTitle = (item.title || '')
          .replace(/<[^>]*>/g, '')
          .replace(/&quot;/g, '"')
          .replace(/&amp;/g, '&');

        return `
          <a href="${escapeAttr(item.link)}" target="_blank" class="news-item">
            <span class="news-title">${escapeHtml(cleanTitle)}</span>
            <span class="news-time">${escapeHtml(timeAgo)}</span>
          </a>
        `;
      }).join('');
    }

    function refreshNews() { loadNews(); }

    function getTimeAgo(date) {
      const diff = new Date() - date;
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (mins < 1) return 'ë°©ê¸ˆ';
      if (mins < 60) return mins + 'ë¶„ ì „';
      if (hrs < 24) return hrs + 'ì‹œê°„ ì „';
      return days + 'ì¼ ì „';
    }

    // ==================== Keyword Modal ====================
    function openKeywordModal() {
      document.getElementById('keywordModal').classList.add('active');
      renderKeywordList();
    }

    function renderKeywordList() {
      document.getElementById('keywordList').innerHTML = state.newsKeywords.map(k => `
        <span class="news-keyword" onclick="deleteKeyword('${escapeAttr(k)}')" style="cursor:pointer;">${escapeHtml(k)} Ã—</span>
      `).join('');
    }

    function addKeyword(e) {
      e.preventDefault();
      const keyword = document.getElementById('newKeyword').value.trim();
      if (keyword && !state.newsKeywords.includes(keyword)) {
        state.newsKeywords.push(keyword);
        state.activeKeyword = keyword;
        saveState();
        renderNewsKeywords();
        renderKeywordList();
        loadNews();
      }
      document.getElementById('newKeyword').value = '';
    }

    function deleteKeyword(keyword) {
      if (state.newsKeywords.length > 1) {
        state.newsKeywords = state.newsKeywords.filter(k => k !== keyword);
        if (state.activeKeyword === keyword) state.activeKeyword = state.newsKeywords[0];
        saveState();
        renderNewsKeywords();
        renderKeywordList();
        loadNews();
      }
    }

    // ==================== Modal ====================
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
      }
    });

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.classList.remove('active');
      });
    });

    // ==================== Start ====================
    init();
  </script>
</body>
</html>
