<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jang's Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #0f0f0f;
      --bg-secondary: #1a1a1a;
      --bg-card: #222222;
      --bg-hover: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #666666;
      --accent: #4ecdc4;
      --accent-hover: #45b7aa;
      --border: #333333;
      --danger: #f87171;
      --memo-yellow: #fef3c7;
      --memo-pink: #fce7f3;
      --memo-blue: #dbeafe;
      --memo-green: #d1fae5;
      --memo-purple: #ede9fe;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      line-height: 1.6;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 30px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--accent);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .current-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    /* Weather */
    .weather-inline {
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--bg-card);
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .weather-icon { font-size: 1.5rem; }
    .weather-temp { font-size: 1.2rem; font-weight: 600; }
    .weather-desc { font-size: 0.85rem; color: var(--text-secondary); }
    .weather-location { font-size: 0.75rem; color: var(--text-muted); }

    /* Layout */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 16px;
      padding: 16px 30px;
      max-width: 1600px;
      margin: 0 auto;
      height: calc(100vh - 70px);
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      transition: all 0.3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 30px rgba(78, 205, 196, 0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      gap: 10px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .card-title-icon { color: var(--accent); }

    .card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .card-btn {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.82rem;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .card-btn:hover {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    .card-btn:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    /* ===== Bookmarks Groups ===== */
    .bookmark-groups-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 10px 6px 6px 6px; /* ÏÉÅÎã® ÌÖåÎëêÎ¶¨ ÏûòÎ¶º Î∞©ÏßÄ */
      align-content: start;
    }

    .bookmark-group {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      margin-bottom: 12px;
      transition: border-color .2s, box-shadow .2s;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .bookmark-group.drag-over {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.12);
    }

    .bookmark-group-name {
      flex: 0 0 140px;
      max-width: 140px;
      font-weight: 800;
      font-size: 0.92rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      padding-top: 6px;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bookmarks-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr)); /* Ìïú Ï§Ñ ÏµúÎåÄ 4Í∞ú */
      gap: 10px;
      padding-top: 2px;
      min-width: 0;
    }

    .bookmark-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: grab;
      transition: border-color .2s, box-shadow .2s, background .2s;
      position: relative;
      height: 52px;
      user-select: none;
      min-width: 0;
    }

    /* hover transform Ï†úÍ±∞(ÏûòÎ¶º Î∞©ÏßÄ) */
    .bookmark-item:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.12);
    }

    .bookmark-item:active { cursor: grabbing; }

    .bookmark-item.dragging {
      opacity: 0.55;
      border-style: dashed;
    }

    /* ÎìúÎ°≠ ÏúÑÏπò ÌëúÏãú(Ï¢å/Ïö∞) */
    .bookmark-item.drop-before {
      box-shadow: inset 4px 0 0 0 rgba(78, 205, 196, 0.85);
      border-color: var(--accent);
    }
    .bookmark-item.drop-after {
      box-shadow: inset -4px 0 0 0 rgba(78, 205, 196, 0.85);
      border-color: var(--accent);
    }

    .bookmark-icon {
      width: 28px;
      height: 28px;
      min-width: 28px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.0rem;
    }

    .bookmark-name {
      font-size: 0.9rem;
      font-weight: 650;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      min-width: 0;
    }

    .bookmark-action {
      position: absolute;
      top: 7px;
      width: 18px;
      height: 18px;
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 11px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }

    .bookmark-delete {
      right: 7px;
      background: var(--danger);
    }

    .bookmark-edit {
      right: 30px;
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .bookmark-edit:hover {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    .bookmark-item:hover .bookmark-action { display: flex; }

    /* Calendar */
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .calendar-nav { display:flex; gap:6px; }
    .calendar-nav button {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    .calendar-nav button:hover { background: var(--accent); color: var(--bg-primary); }
    .calendar-week-label { font-weight: 600; color: var(--text-primary); font-size: 0.9rem; }

    .week-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:10px; }
    .week-day {
      text-align:center; padding:8px 4px;
      background: var(--bg-secondary);
      border-radius:6px;
      cursor:pointer; transition:all 0.2s;
      border:2px solid transparent;
    }
    .week-day:hover { background: var(--bg-hover); }
    .week-day.today { background: var(--accent); color: var(--bg-primary); }
    .week-day.today .week-day-name { color: var(--bg-primary); }
    .week-day.selected { border-color: var(--accent); background: rgba(78, 205, 196, 0.15); }
    .week-day-name { font-size:0.7rem; color: var(--text-muted); margin-bottom:2px; }
    .week-day-num { font-size:1rem; font-weight:600; }
    .week-day-dots { display:flex; justify-content:center; gap:2px; margin-top:4px; min-height:5px; }
    .event-dot { width:5px; height:5px; border-radius:50%; background: var(--accent); }
    .week-day.today .event-dot { background: var(--bg-primary); }

    .events-date-header {
      font-size:0.8rem; color: var(--text-muted);
      margin-bottom:8px; padding-bottom:6px;
      border-bottom:1px solid var(--border);
    }
    .events-list { height:88px; min-height:88px; max-height:88px; overflow-y:auto; }
    .event-item {
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; background: var(--bg-secondary);
      border-radius:6px; margin-bottom:4px;
      border-left:3px solid var(--accent);
      font-size:0.85rem;
    }
    .event-item.google-event { border-left-color:#4285f4; }
    .event-time {
      font-family:'JetBrains Mono', monospace;
      font-size:0.75rem; color: var(--accent);
      min-width:80px;
    }
    .event-item.google-event .event-time { color:#4285f4; }
    .event-title { flex:1; }
    .event-source {
      font-size:0.65rem; color: var(--text-muted);
      background: var(--bg-hover);
      padding:2px 5px; border-radius:3px;
    }
    .event-empty { text-align:center; color: var(--text-muted); padding:30px 16px; font-size:0.85rem; }

    /* Google status pill */
    .g-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      font-size: 0.78rem;
      white-space: nowrap;
    }
    .g-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    .g-pill.connected .g-dot { background: #4285f4; }
    .g-pill.connected { border-color: rgba(66, 133, 244, 0.6); }

    /* Memo */
    .memo-container { min-height:200px; max-height:200px; }
    .memo-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; max-height:200px; overflow-y:auto; padding:4px; }
    .memo-postit {
      background: var(--memo-yellow);
      border-radius:4px; padding:10px;
      min-height:90px; max-height:90px;
      cursor:pointer; transition:all 0.2s;
      position:relative;
      box-shadow:2px 2px 8px rgba(0,0,0,0.3);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .memo-postit:hover { transform: translateY(-3px) rotate(1deg); box-shadow:4px 4px 12px rgba(0,0,0,0.4); }
    .memo-postit.yellow { background: var(--memo-yellow); }
    .memo-postit.pink { background: var(--memo-pink); }
    .memo-postit.blue { background: var(--memo-blue); }
    .memo-postit.green { background: var(--memo-green); }
    .memo-postit.purple { background: var(--memo-purple); }
    .memo-postit-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
    .memo-postit-title { font-size:0.8rem; font-weight:600; color:#333; flex:1; word-break:break-word; }
    .memo-postit-date { font-size:0.65rem; color:#666; }
    .memo-postit-content {
      font-size:0.7rem; color:#444; flex:1; overflow:hidden;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      line-height:1.3; word-break:break-word;
    }
    .memo-postit-delete {
      position:absolute; top:4px; right:4px;
      width:18px; height:18px;
      background: rgba(0,0,0,0.3);
      border:none; border-radius:50%;
      color:white; font-size:10px;
      cursor:pointer; display:none;
      align-items:center; justify-content:center;
    }
    .memo-postit:hover .memo-postit-delete { display:flex; }
    .memo-postit-add {
      background: var(--bg-secondary);
      border:2px dashed var(--border);
      display:flex; align-items:center; justify-content:center;
      color: var(--text-muted);
      font-size:2rem;
    }
    .memo-postit-add:hover { border-color: var(--accent); color: var(--accent); transform:none; box-shadow:none; }

    /* News */
    .news-keyword-bar { display:flex; gap:5px; margin-bottom:8px; flex-wrap:wrap; }
    .news-keyword {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding:4px 12px;
      border-radius:16px;
      font-size:0.8rem;
      color: var(--text-secondary);
      cursor:pointer; transition:all 0.2s;
    }
    .news-keyword:hover, .news-keyword.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }
    .news-list { max-height:200px; overflow-y:auto; }
    .news-item {
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:8px 10px;
      background: var(--bg-secondary);
      border-radius:5px;
      margin-bottom:4px;
      text-decoration:none;
      transition:all 0.2s;
      border:1px solid transparent;
    }
    .news-item:hover { background: var(--bg-hover); border-color: var(--accent); }
    .news-title {
      color: var(--text-primary);
      font-size:0.78rem;
      line-height:1.3;
      flex:1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .news-time { font-size:0.7rem; color: var(--text-muted); white-space:nowrap; flex-shrink:0; }
    .news-loading { text-align:center; padding:30px; color: var(--text-muted); font-size:0.85rem; line-height:1.6; }

    /* Modal */
    .modal-overlay {
      display:none;
      position:fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.8);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .modal-overlay.active { display:flex; }
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius:16px;
      padding:24px;
      width:90%;
      max-width:520px;
      max-height:80vh;
      overflow-y:auto;
    }
    .modal-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:20px;
    }
    .modal-title { font-size:1.1rem; font-weight:600; }
    .modal-close {
      background:none; border:none;
      color: var(--text-muted);
      font-size:1.5rem;
      cursor:pointer;
    }
    .modal-close:hover { color: var(--text-primary); }
    .form-group { margin-bottom:16px; }
    .form-label { display:block; margin-bottom:6px; color: var(--text-secondary); font-size:0.85rem; }
    .form-input, .form-textarea, select.form-input {
      width:100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius:8px;
      padding:10px 12px;
      color: var(--text-primary);
      font-size:0.9rem;
      font-family:'Noto Sans KR', sans-serif;
    }
    .form-textarea { min-height:120px; resize:vertical; }
    .form-input:focus, .form-textarea:focus { outline:none; border-color: var(--accent); }

    .form-color-options { display:flex; gap:8px; }
    .color-option {
      width:28px; height:28px;
      border-radius:50%;
      border:2px solid transparent;
      cursor:pointer;
      transition:all 0.2s;
    }
    .color-option:hover, .color-option.selected { transform: scale(1.1); border-color: var(--text-primary); }
    .color-option.yellow { background: var(--memo-yellow); }
    .color-option.pink { background: var(--memo-pink); }
    .color-option.blue { background: var(--memo-blue); }
    .color-option.green { background: var(--memo-green); }
    .color-option.purple { background: var(--memo-purple); }

    .form-submit {
      width:100%;
      background: var(--accent);
      border:none;
      color: var(--bg-primary);
      padding:12px;
      border-radius:8px;
      font-size:0.95rem;
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s;
    }
    .form-submit:hover { background: var(--accent-hover); }

    /* Settings dropdown */
    .settings-dropdown { position:relative; }
    .settings-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding:8px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:0.85rem;
      transition:all 0.2s;
      white-space:nowrap;
    }
    .settings-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .settings-menu {
      display:none;
      position:absolute;
      top:100%;
      right:0;
      margin-top:8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius:10px;
      padding:8px;
      min-width:180px;
      z-index:100;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }
    .settings-menu.active { display:block; }
    .settings-menu button {
      display:block; width:100%;
      background:none; border:none;
      color: var(--text-secondary);
      padding:10px 12px;
      text-align:left;
      cursor:pointer;
      border-radius:6px;
      font-size:0.85rem;
      transition:all 0.2s;
    }
    .settings-menu button:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* Scrollbar */
    ::-webkit-scrollbar { width:5px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-left">
      <h1>Jang's Dashboard</h1>
    </div>
    <div class="header-right">
      <div class="weather-inline" id="weatherWidget">
        <span class="weather-icon" id="weatherIcon">üå°Ô∏è</span>
        <div>
          <span class="weather-temp" id="weatherTemp">--¬∞</span>
          <span class="weather-desc" id="weatherDesc">Î°úÎî©Ï§ë...</span>
        </div>
        <span class="weather-location" id="weatherLocation">üìç --</span>
      </div>
      <div class="current-time" id="currentTime">00:00:00</div>

      <div class="settings-dropdown">
        <button class="settings-btn" onclick="toggleSettingsMenu()">‚öôÔ∏è ÏÑ§Ï†ï</button>
        <div class="settings-menu" id="settingsMenu">
          <button onclick="exportToJson()">üì• JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
          <button onclick="document.getElementById('jsonFileInput').click()">üì§ JSON Î∂àÎü¨Ïò§Í∏∞</button>
          <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="importFromJson(event)">
        </div>
      </div>
    </div>
  </header>

  <main class="main-container">
    <!-- Bookmarks -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="card-title-icon">‚≠ê</span>
          Ï¶êÍ≤®Ï∞æÎäî ÏÇ¨Ïù¥Ìä∏
        </div>

        <div class="card-actions">
          <button class="card-btn" onclick="openBookmarkGroupModal()">Í∑∏Î£π Í¥ÄÎ¶¨</button>
          <button class="card-btn" onclick="openAddBookmarkModal()">ÏÇ¨Ïù¥Ìä∏ Ï∂îÍ∞Ä</button>
        </div>
      </div>

      <div class="bookmark-groups-scroll" id="bookmarkGroupsScroll"></div>
    </div>

    <!-- Calendar -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="card-title-icon">üìÖ</span>Ï£ºÍ∞Ñ ÏùºÏ†ï</div>

        <!-- ‚úÖ Ïó¨Í∏∞Î°ú Ïù¥Îèô: Ïó∞Í≤∞/Ï∫òÎ¶∞ÎçîÏÑ†ÌÉùÏùÄ +ÏùºÏ†ï ÏôºÏ™Ω -->
        <div class="card-actions">
          <span class="g-pill disconnected" id="gPill">
            <span class="g-dot"></span>
            <span id="gPillText">Google ÎØ∏Ïó∞Í≤∞</span>
          </span>
          <button class="card-btn" id="googleCalendarSelectBtn" onclick="openCalendarSelectModal()" style="display:none;">Ï∫òÎ¶∞Îçî ÏÑ†ÌÉù</button>
          <button class="card-btn" id="googleBtn" onclick="handleGoogleAuth()">Google Ïó∞Í≤∞</button>
          <button class="card-btn" onclick="openAddEventModal()">+ ÏùºÏ†ï</button>
        </div>
      </div>

      <div class="calendar-header">
        <div class="calendar-nav">
          <button onclick="changeWeek(-1)">‚óÄ</button>
          <button onclick="goToToday()">Ïò§Îäò</button>
          <button onclick="changeWeek(1)">‚ñ∂</button>
        </div>
        <div class="calendar-week-label" id="calendarWeekLabel">1Ïõî 2Ï£ºÏ∞®</div>
      </div>

      <div class="week-grid" id="weekGrid"></div>
      <div id="selectedDateHeader" class="events-date-header"></div>
      <div class="events-list" id="eventsList"></div>
    </div>

    <!-- Memo -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="card-title-icon">üìù</span>Î©îÎ™®</div>
        <div class="card-actions">
          <button class="card-btn" onclick="exportAllMemos()">ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        </div>
      </div>
      <div class="memo-container">
        <div class="memo-grid" id="memoGrid"></div>
      </div>
    </div>

    <!-- News -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="card-title-icon">üì∞</span>Îâ¥Ïä§</div>
        <div class="card-actions">
          <button class="card-btn" onclick="openKeywordModal()">ÌÇ§ÏõåÎìú</button>
          <button class="card-btn" onclick="refreshNews()">ÏÉàÎ°úÍ≥†Ïπ®</button>
        </div>
      </div>
      <div class="news-keyword-bar" id="newsKeywords"></div>
      <div class="news-list" id="newsList">
        <div class="news-loading">Îâ¥Ïä§Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Bookmark Modal -->
  <div class="modal-overlay" id="bookmarkModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="bookmarkModalTitle">ÏÇ¨Ïù¥Ìä∏ Ï∂îÍ∞Ä</div>
        <button class="modal-close" onclick="closeModal('bookmarkModal')">√ó</button>
      </div>

      <form onsubmit="saveBookmark(event)">
        <input type="hidden" id="bookmarkEditId" value="">
        <div class="form-group">
          <label class="form-label">ÏÇ¨Ïù¥Ìä∏ Ïù¥Î¶Ñ</label>
          <input type="text" class="form-input" id="bookmarkName" placeholder="Ïòà: ChatGPT" required>
        </div>

        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="url" class="form-input" id="bookmarkUrl" placeholder="https://..." required>
        </div>

        <div class="form-group">
          <label class="form-label">ÏïÑÏù¥ÏΩò (Ïù¥Î™®ÏßÄ)</label>
          <input type="text" class="form-input" id="bookmarkIcon" placeholder="üåê" maxlength="2">
        </div>

        <div class="form-group">
          <label class="form-label">Í∑∏Î£π</label>
          <select class="form-input" id="bookmarkGroup"></select>
        </div>

        <button type="submit" class="form-submit" id="bookmarkSubmitBtn">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
      </form>
    </div>
  </div>

  <!-- Bookmark Group Modal -->
  <div class="modal-overlay" id="bookmarkGroupModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Í∑∏Î£π Í¥ÄÎ¶¨</div>
        <button class="modal-close" onclick="closeModal('bookmarkGroupModal')">√ó</button>
      </div>

      <div class="form-group">
        <label class="form-label">ÏÉà Í∑∏Î£π Ï∂îÍ∞Ä</label>
        <div style="display:flex; gap:8px;">
          <input type="text" class="form-input" id="newBookmarkGroupName" placeholder="Ïòà: AI, ÏóÖÎ¨¥, ÏáºÌïë">
          <button class="card-btn" type="button" onclick="addBookmarkGroup()">Ï∂îÍ∞Ä</button>
        </div>
      </div>

      <div style="margin-top: 16px;">
        <label class="form-label">ÌòÑÏû¨ Í∑∏Î£π</label>
        <div id="bookmarkGroupList" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ÏùºÏ†ï Ï∂îÍ∞Ä</div>
        <button class="modal-close" onclick="closeModal('eventModal')">√ó</button>
      </div>
      <form onsubmit="addEvent(event)">
        <div class="form-group">
          <label class="form-label">ÏùºÏ†ï Ï†úÎ™©</label>
          <input type="text" class="form-input" id="eventTitle" placeholder="ÌöåÏùò, ÏïΩÏÜç Îì±" required>
        </div>
        <div class="form-group">
          <label class="form-label">ÎÇ†Ïßú</label>
          <input type="date" class="form-input" id="eventDate" required>
        </div>
        <div class="form-group">
          <label class="form-label">ÏãúÍ∞Ñ</label>
          <input type="time" class="form-input" id="eventTime">
        </div>
        <button type="submit" class="form-submit">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
      </form>
    </div>
  </div>

  <!-- Add/Edit Memo Modal -->
  <div class="modal-overlay" id="memoModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="memoModalTitle">Î©îÎ™® Ï∂îÍ∞Ä</div>
        <button class="modal-close" onclick="closeModal('memoModal')">√ó</button>
      </div>
      <form onsubmit="saveMemo(event)">
        <input type="hidden" id="memoEditIndex" value="-1">
        <div class="form-group">
          <label class="form-label">Ï†úÎ™©</label>
          <input type="text" class="form-input" id="memoTitle" placeholder="Î©îÎ™® Ï†úÎ™©" required>
        </div>
        <div class="form-group">
          <label class="form-label">ÎÇ¥Ïö©</label>
          <textarea class="form-textarea" id="memoContent" placeholder="Î©îÎ™® ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ÏÉâÏÉÅ</label>
          <div class="form-color-options" id="colorOptions">
            <div class="color-option yellow selected" data-color="yellow" onclick="selectColor('yellow')"></div>
            <div class="color-option pink" data-color="pink" onclick="selectColor('pink')"></div>
            <div class="color-option blue" data-color="blue" onclick="selectColor('blue')"></div>
            <div class="color-option green" data-color="green" onclick="selectColor('green')"></div>
            <div class="color-option purple" data-color="purple" onclick="selectColor('purple')"></div>
          </div>
        </div>
        <button type="submit" class="form-submit">Ï†ÄÏû•ÌïòÍ∏∞</button>
      </form>
    </div>
  </div>

  <!-- Keyword Modal -->
  <div class="modal-overlay" id="keywordModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Îâ¥Ïä§ ÌÇ§ÏõåÎìú Í¥ÄÎ¶¨</div>
        <button class="modal-close" onclick="closeModal('keywordModal')">√ó</button>
      </div>
      <form onsubmit="addKeyword(event)">
        <div class="form-group">
          <label class="form-label">ÏÉà ÌÇ§ÏõåÎìú</label>
          <input type="text" class="form-input" id="newKeyword" placeholder="Ïòà: AI, Ï£ºÏãù, Î∂ÄÎèôÏÇ∞" required>
        </div>
        <button type="submit" class="form-submit">Ï∂îÍ∞ÄÌïòÍ∏∞</button>
      </form>
      <div style="margin-top: 16px;">
        <label class="form-label">ÌòÑÏû¨ ÌÇ§ÏõåÎìú (ÌÅ¥Î¶≠ÌïòÏó¨ ÏÇ≠Ï†ú)</label>
        <div id="keywordList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
      </div>
    </div>
  </div>

  <!-- Calendar Select Modal -->
  <div class="modal-overlay" id="calendarSelectModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ÌëúÏãúÌï† Ï∫òÎ¶∞Îçî ÏÑ†ÌÉù</div>
        <button class="modal-close" onclick="closeModal('calendarSelectModal')">√ó</button>
      </div>
      <div id="calendarList" style="max-height: 300px; overflow-y: auto;">
        <div class="news-loading">Ï∫òÎ¶∞Îçî Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
      </div>
      <button class="form-submit" onclick="saveCalendarSelection()" style="margin-top: 16px;">Ï†ÄÏû•</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // ==================== State ====================
    let state = {
      bookmarks: [],
      bookmarkGroups: [{ id: 'default', name: 'Í∏∞Î≥∏' }],
      bookmarkOrderMap: {},
      events: [],
      googleEvents: [],
      googleCalendars: [],
      selectedCalendars: [],
      memos: [],
      newsKeywords: ['IT', 'Í≤ΩÏ†ú', 'Î∂ÄÎèôÏÇ∞'],
      activeKeyword: 'IT',
      newsProvider: 'naver',
      currentWeekStart: null,
      selectedDate: null,

      googleConnected: false,
      googleAccessToken: null,
      googleTokenExpiresAt: null,  // ‚úÖ expires_in Í∏∞Î∞òÏúºÎ°ú ÎßåÎ£å ÏãúÍ∞Å Ï†ÄÏû•(Î∞ÄÎ¶¨Ï¥à)
      selectedMemoColor: 'yellow'
    };

    // Google Calendar API
    const GOOGLE_CLIENT_ID = '616051020242-mg4r2ccc0iks3ssqhjuula6f1sr1o0p8.apps.googleusercontent.com';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

    let dragState = {
      draggingId: null,
      isDragging: false,
      lastMarkerId: null
    };

    // Utils
    function uid(prefix = 'id') {
      return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
    }

    function getLocalDateStr(date) {
      const d = date || new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseLocalDate(dateStr) {
      const [year, month, day] = dateStr.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function escapeQuotes(str) {
      return String(str ?? '').replaceAll("'", "\\'").replaceAll('"', '\\"');
    }

    // ==================== Storage ====================
    function loadState() {
      const saved = localStorage.getItem('dashboardState_v3');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        } catch (e) {}
      }

      const googleToken = localStorage.getItem('googleAccessToken');
      const googleExpiresAt = localStorage.getItem('googleTokenExpiresAt');
      if (googleToken) {
        state.googleAccessToken = googleToken;
        state.googleConnected = true;
      }
      if (googleExpiresAt) {
        state.googleTokenExpiresAt = Number(googleExpiresAt);
      }

      state.currentWeekStart = getWeekStart(new Date());
      state.selectedDate = getLocalDateStr(new Date());

      normalizeBookmarksAndGroups();
    }

    function saveState() {
      const toSave = {
        bookmarks: state.bookmarks,
        bookmarkGroups: state.bookmarkGroups,
        bookmarkOrderMap: state.bookmarkOrderMap,
        events: state.events,
        memos: state.memos,
        newsKeywords: state.newsKeywords,
        newsProvider: state.newsProvider,
        selectedCalendars: state.selectedCalendars
      };
      localStorage.setItem('dashboardState_v3', JSON.stringify(toSave));
    }

    // ==================== Normalize / Migration ====================
    function normalizeBookmarksAndGroups() {
      if (!Array.isArray(state.bookmarkGroups) || state.bookmarkGroups.length === 0) {
        state.bookmarkGroups = [{ id: 'default', name: 'Í∏∞Î≥∏' }];
      }
      if (!state.bookmarkGroups.some(g => g.id === 'default')) {
        state.bookmarkGroups.unshift({ id: 'default', name: 'Í∏∞Î≥∏' });
      }

      if (!Array.isArray(state.bookmarks)) state.bookmarks = [];
      if (!state.bookmarkOrderMap || typeof state.bookmarkOrderMap !== 'object') state.bookmarkOrderMap = {};

      state.bookmarks = state.bookmarks.map(b => ({
        id: b.id || uid('bm'),
        name: b.name || '(Ïù¥Î¶Ñ ÏóÜÏùå)',
        url: b.url || '#',
        icon: b.icon || 'üîó',
        groupId: b.groupId || 'default'
      }));

      const groupIds = new Set(state.bookmarkGroups.map(g => g.id));
      state.bookmarks = state.bookmarks.map(b => groupIds.has(b.groupId) ? b : ({ ...b, groupId: 'default' }));

      if (state.bookmarks.length === 0) {
        state.bookmarks = [
          { id: uid('bm'), name: 'ChatGPT', url: 'https://chat.openai.com', icon: 'ü§ñ', groupId: 'default' },
          { id: uid('bm'), name: 'Gemini', url: 'https://gemini.google.com', icon: '‚ú®', groupId: 'default' },
          { id: uid('bm'), name: 'Claude', url: 'https://claude.ai', icon: '‚úçÔ∏è', groupId: 'default' },
          { id: uid('bm'), name: 'GitHub', url: 'https://github.com', icon: 'üíª', groupId: 'default' }
        ];
      }

      for (const g of state.bookmarkGroups) {
        const existing = Array.isArray(state.bookmarkOrderMap[g.id]) ? state.bookmarkOrderMap[g.id] : [];
        const groupBms = state.bookmarks.filter(b => b.groupId === g.id).map(b => b.id);

        const cleaned = existing.filter(id => groupBms.includes(id));
        const missing = groupBms.filter(id => !cleaned.includes(id));
        state.bookmarkOrderMap[g.id] = [...cleaned, ...missing];
      }

      saveState();
    }

    function getBookmarksByGroupOrdered(groupId) {
      const order = state.bookmarkOrderMap[groupId] || [];
      const map = new Map(state.bookmarks.map(b => [b.id, b]));
      return order.map(id => map.get(id)).filter(Boolean);
    }

    // ==================== Init ====================
    function init() {
      loadState();
      handleOAuthCallback();

      updateTime();
      setInterval(updateTime, 1000);

      // ÌÜ†ÌÅ∞ ÎßåÎ£å Ï≤¥ÌÅ¨(ÏûàÏúºÎ©¥)
      setInterval(checkGoogleTokenExpiry, 30 * 1000);

      getWeather();
      renderBookmarkGroups();
      updateGoogleStatus();
      renderWeeklyCalendar();
      renderMemos();
      renderNewsKeywords();
      loadNews();

      if (state.googleConnected) {
        fetchGoogleCalendarList();
        fetchGoogleCalendarEvents();
      }
    }

    // ==================== Settings JSON ====================
    function toggleSettingsMenu() {
      document.getElementById('settingsMenu').classList.toggle('active');
    }

    document.addEventListener('click', (e) => {
      const dropdown = document.querySelector('.settings-dropdown');
      const menu = document.getElementById('settingsMenu');
      if (dropdown && !dropdown.contains(e.target)) menu.classList.remove('active');
    });

    function exportToJson() {
      const exportData = {
        version: '2.2',
        exportDate: getLocalDateStr(new Date()),
        bookmarks: state.bookmarks,
        bookmarkGroups: state.bookmarkGroups,
        bookmarkOrderMap: state.bookmarkOrderMap,
        events: state.events,
        memos: state.memos,
        newsKeywords: state.newsKeywords,
        newsProvider: state.newsProvider,
        selectedCalendars: state.selectedCalendars
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dashboard_backup_${getLocalDateStr(new Date())}.json`;
      a.click();
      URL.revokeObjectURL(url);

      document.getElementById('settingsMenu').classList.remove('active');
      alert('ÏÑ§Ï†ïÏù¥ JSON ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
    }

    function importFromJson(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importData = JSON.parse(e.target.result);

          if (importData.bookmarks) state.bookmarks = importData.bookmarks;
          if (importData.bookmarkGroups) state.bookmarkGroups = importData.bookmarkGroups;
          if (importData.bookmarkOrderMap) state.bookmarkOrderMap = importData.bookmarkOrderMap;
          if (importData.events) state.events = importData.events;
          if (importData.memos) state.memos = importData.memos;
          if (importData.newsKeywords) state.newsKeywords = importData.newsKeywords;
          if (importData.newsProvider) state.newsProvider = importData.newsProvider;
          if (importData.selectedCalendars) state.selectedCalendars = importData.selectedCalendars;

          normalizeBookmarksAndGroups();

          renderBookmarkGroups();
          renderWeeklyCalendar();
          renderMemos();
          renderNewsKeywords();
          loadNews();

          alert('ÏÑ§Ï†ïÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
        } catch (err) {
          alert('JSON ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
          console.error(err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
      document.getElementById('settingsMenu').classList.remove('active');
    }

    // ==================== Time ====================
    function updateTime() {
      document.getElementById('currentTime').textContent =
        new Date().toLocaleTimeString('ko-KR', { hour12: false });
    }

    // ==================== Weather ====================
    async function getWeather() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
          () => fetchWeather(37.5665, 126.9780)
        );
      } else {
        fetchWeather(37.5665, 126.9780);
      }
    }

    async function fetchWeather(lat, lon) {
      try {
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=auto`);
        const data = await res.json();

        const temp = Math.round(data.current.temperature_2m);
        const code = data.current.weather_code;

        document.getElementById('weatherTemp').textContent = temp + '¬∞';
        document.getElementById('weatherDesc').textContent = getWeatherDesc(code);
        document.getElementById('weatherIcon').textContent = getWeatherIcon(code);

        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ko`);
        const geoData = await geoRes.json();
        const loc = geoData.address.city || geoData.address.town || geoData.address.district || 'Ïïå Ïàò ÏóÜÏùå';
        document.getElementById('weatherLocation').textContent = 'üìç ' + loc;
      } catch (e) {
        document.getElementById('weatherDesc').textContent = 'ÎÇ†Ïî® Ï†ïÎ≥¥ ÏóÜÏùå';
      }
    }

    function getWeatherIcon(code) {
      const icons = { 0:'‚òÄÔ∏è', 1:'üå§Ô∏è', 2:'‚õÖ', 3:'‚òÅÔ∏è', 45:'üå´Ô∏è', 48:'üå´Ô∏è', 51:'üåßÔ∏è', 53:'üåßÔ∏è', 55:'üåßÔ∏è', 61:'üåßÔ∏è', 63:'üåßÔ∏è', 65:'üåßÔ∏è', 71:'üå®Ô∏è', 73:'üå®Ô∏è', 75:'üå®Ô∏è', 80:'üåßÔ∏è', 81:'üåßÔ∏è', 82:'üåßÔ∏è', 95:'‚õàÔ∏è', 96:'‚õàÔ∏è', 99:'‚õàÔ∏è' };
      return icons[code] || 'üå°Ô∏è';
    }

    function getWeatherDesc(code) {
      const desc = { 0:'ÎßëÏùå', 1:'ÎåÄÏ≤¥Î°ú ÎßëÏùå', 2:'Î∂ÄÎ∂ÑÏ†Å ÌùêÎ¶º', 3:'ÌùêÎ¶º', 45:'ÏïàÍ∞ú', 48:'ÏïàÍ∞ú', 51:'Ïù¥Ïä¨ÎπÑ', 53:'Ïù¥Ïä¨ÎπÑ', 55:'Ïù¥Ïä¨ÎπÑ', 61:'ÎπÑ', 63:'ÎπÑ', 65:'Ìè≠Ïö∞', 71:'Îàà', 73:'Îàà', 75:'Ìè≠ÏÑ§', 80:'ÏÜåÎÇòÍ∏∞', 81:'ÏÜåÎÇòÍ∏∞', 82:'Ìè≠Ïö∞', 95:'ÎáåÏö∞', 96:'ÎáåÏö∞', 99:'ÎáåÏö∞' };
      return desc[code] || 'Ï†ïÎ≥¥ ÏóÜÏùå';
    }

    // ==================== Bookmarks: Render ====================
    function renderBookmarkGroups() {
      const wrap = document.getElementById('bookmarkGroupsScroll');

      wrap.innerHTML = state.bookmarkGroups.map(g => {
        const items = getBookmarksByGroupOrdered(g.id);

        const tiles = items.map(b => `
          <div class="bookmark-item"
               draggable="true"
               data-bm-id="${b.id}"
               data-group-id="${g.id}"
               ondragstart="onBookmarkDragStart(event, '${b.id}')"
               ondragend="onBookmarkDragEnd(event)"
               ondragover="onBookmarkDragOverItem(event, '${b.id}')"
               ondragleave="onBookmarkDragLeaveItem(event, '${b.id}')"
               ondrop="onBookmarkDropOnItem(event, '${g.id}', '${b.id}')"
               onclick="onBookmarkClick('${escapeQuotes(b.url)}')">
            <button class="bookmark-action bookmark-edit" onclick="openEditBookmarkModal(event, '${b.id}')">‚úé</button>
            <button class="bookmark-action bookmark-delete" onclick="deleteBookmark(event, '${b.id}')">√ó</button>

            <div class="bookmark-icon">${b.icon || 'üîó'}</div>
            <div class="bookmark-name" title="${escapeHtml(b.name)}">${escapeHtml(b.name)}</div>
          </div>
        `).join('');

        return `
          <div class="bookmark-group"
               id="group_${g.id}"
               ondragover="onGroupDragOver(event, '${g.id}')"
               ondragleave="onGroupDragLeave(event, '${g.id}')"
               ondrop="onGroupDrop(event, '${g.id}')">
            <div class="bookmark-group-name" title="${escapeHtml(g.name)}">üìÅ ${escapeHtml(g.name)}</div>
            <div class="bookmarks-grid">
              ${tiles}
            </div>
          </div>
        `;
      }).join('');
    }

    function onBookmarkClick(url) {
      if (dragState.isDragging) return;
      if (!url || url === '#') return;
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    // ==================== Bookmarks: Add/Edit Modal ====================
    function fillBookmarkGroupSelect(selectedId = 'default') {
      const select = document.getElementById('bookmarkGroup');
      select.innerHTML = state.bookmarkGroups.map(g => `
        <option value="${g.id}" ${g.id === selectedId ? 'selected' : ''}>${escapeHtml(g.name)}</option>
      `).join('');
    }

    function openAddBookmarkModal() {
      document.getElementById('bookmarkModalTitle').textContent = 'ÏÇ¨Ïù¥Ìä∏ Ï∂îÍ∞Ä';
      document.getElementById('bookmarkSubmitBtn').textContent = 'Ï∂îÍ∞ÄÌïòÍ∏∞';
      document.getElementById('bookmarkEditId').value = '';
      document.getElementById('bookmarkName').value = '';
      document.getElementById('bookmarkUrl').value = '';
      document.getElementById('bookmarkIcon').value = '';
      fillBookmarkGroupSelect('default');
      document.getElementById('bookmarkModal').classList.add('active');
    }

    function openEditBookmarkModal(e, bookmarkId) {
      e.preventDefault();
      e.stopPropagation();

      const bm = state.bookmarks.find(b => b.id === bookmarkId);
      if (!bm) return;

      document.getElementById('bookmarkModalTitle').textContent = 'ÏÇ¨Ïù¥Ìä∏ ÏàòÏ†ï';
      document.getElementById('bookmarkSubmitBtn').textContent = 'Ï†ÄÏû•ÌïòÍ∏∞';
      document.getElementById('bookmarkEditId').value = bm.id;
      document.getElementById('bookmarkName').value = bm.name;
      document.getElementById('bookmarkUrl').value = bm.url;
      document.getElementById('bookmarkIcon').value = bm.icon || '';
      fillBookmarkGroupSelect(bm.groupId);

      document.getElementById('bookmarkModal').classList.add('active');
    }

    function saveBookmark(e) {
      e.preventDefault();

      const editId = document.getElementById('bookmarkEditId').value || '';
      const name = document.getElementById('bookmarkName').value.trim();
      const url = document.getElementById('bookmarkUrl').value.trim();
      const icon = (document.getElementById('bookmarkIcon').value || 'üîó').trim();
      const groupId = document.getElementById('bookmarkGroup').value || 'default';

      if (!editId) {
        // add
        const id = uid('bm');
        state.bookmarks.push({ id, name, url, icon, groupId });

        if (!Array.isArray(state.bookmarkOrderMap[groupId])) state.bookmarkOrderMap[groupId] = [];
        state.bookmarkOrderMap[groupId].push(id);
      } else {
        // edit
        const bm = state.bookmarks.find(b => b.id === editId);
        if (!bm) return;

        const oldGroupId = bm.groupId;

        bm.name = name;
        bm.url = url;
        bm.icon = icon;

        if (oldGroupId !== groupId) {
          // group Ïù¥Îèô(Î™®Îã¨Î°úÎèÑ Í∞ÄÎä•)
          bm.groupId = groupId;

          state.bookmarkOrderMap[oldGroupId] = (state.bookmarkOrderMap[oldGroupId] || []).filter(x => x !== editId);
          if (!Array.isArray(state.bookmarkOrderMap[groupId])) state.bookmarkOrderMap[groupId] = [];
          state.bookmarkOrderMap[groupId].push(editId);
        }
      }

      saveState();
      renderBookmarkGroups();
      closeModal('bookmarkModal');
    }

    function deleteBookmark(e, bookmarkId) {
      e.preventDefault();
      e.stopPropagation();
      if (!confirm('Ïù¥ Î∂ÅÎßàÌÅ¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

      const bm = state.bookmarks.find(b => b.id === bookmarkId);
      if (!bm) return;

      state.bookmarks = state.bookmarks.filter(b => b.id !== bookmarkId);
      state.bookmarkOrderMap[bm.groupId] = (state.bookmarkOrderMap[bm.groupId] || []).filter(id => id !== bookmarkId);

      saveState();
      renderBookmarkGroups();
    }

    // ==================== Bookmarks: DnD (Ï¢å/Ïö∞ Î∞òÏúºÎ°ú before/after) ====================
    function clearDropMarkers() {
      document.querySelectorAll('.bookmark-item.drop-before').forEach(el => el.classList.remove('drop-before'));
      document.querySelectorAll('.bookmark-item.drop-after').forEach(el => el.classList.remove('drop-after'));
      dragState.lastMarkerId = null;
    }

    function onBookmarkDragStart(e, bookmarkId) {
      dragState.draggingId = bookmarkId;
      dragState.isDragging = true;
      try {
        e.dataTransfer.setData('text/plain', bookmarkId);
        e.dataTransfer.effectAllowed = 'move';
      } catch (err) {}

      e.currentTarget.classList.add('dragging');
      clearDropMarkers();
    }

    function onBookmarkDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      dragState.draggingId = null;

      setTimeout(() => { dragState.isDragging = false; }, 80);

      state.bookmarkGroups.forEach(g => {
        const groupEl = document.getElementById(`group_${g.id}`);
        if (groupEl) groupEl.classList.remove('drag-over');
      });

      clearDropMarkers();
    }

    function onGroupDragOver(e, groupId) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      const groupEl = document.getElementById(`group_${groupId}`);
      if (groupEl) groupEl.classList.add('drag-over');

      clearDropMarkers();
    }

    function onGroupDragLeave(e, groupId) {
      const groupEl = document.getElementById(`group_${groupId}`);
      if (!groupEl) return;

      const rect = groupEl.getBoundingClientRect();
      const x = e.clientX, y = e.clientY;
      const inside = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
      if (!inside) groupEl.classList.remove('drag-over');
    }

    function onGroupDrop(e, targetGroupId) {
      e.preventDefault();
      const bookmarkId = e.dataTransfer.getData('text/plain') || dragState.draggingId;
      if (!bookmarkId) return;

      moveBookmarkToGroupAppend(bookmarkId, targetGroupId);
      saveState();
      renderBookmarkGroups();
    }

    function onBookmarkDragOverItem(e, targetId) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';

      if (dragState.draggingId && dragState.draggingId === targetId) {
        clearDropMarkers();
        return;
      }

      const el = document.querySelector(`.bookmark-item[data-bm-id="${targetId}"]`);
      if (!el) return;

      const rect = el.getBoundingClientRect();
      const isBefore = e.clientX < (rect.left + rect.width / 2);

      // marker Í∞±Ïã†
      clearDropMarkers();
      el.classList.add(isBefore ? 'drop-before' : 'drop-after');
      dragState.lastMarkerId = targetId;
    }

    function onBookmarkDragLeaveItem(e, targetId) {
      const el = document.querySelector(`.bookmark-item[data-bm-id="${targetId}"]`);
      if (el) {
        el.classList.remove('drop-before');
        el.classList.remove('drop-after');
      }
    }

    function onBookmarkDropOnItem(e, targetGroupId, targetBookmarkId) {
      e.preventDefault();
      const bookmarkId = e.dataTransfer.getData('text/plain') || dragState.draggingId;
      if (!bookmarkId) return;
      if (bookmarkId === targetBookmarkId) return;

      const el = document.querySelector(`.bookmark-item[data-bm-id="${targetBookmarkId}"]`);
      let position = 'before';
      if (el) {
        const rect = el.getBoundingClientRect();
        position = (e.clientX < (rect.left + rect.width / 2)) ? 'before' : 'after';
      }

      moveBookmarkToGroupRelative(bookmarkId, targetGroupId, targetBookmarkId, position);
      saveState();
      renderBookmarkGroups();
    }

    function moveBookmarkToGroupAppend(bookmarkId, targetGroupId) {
      const bm = state.bookmarks.find(b => b.id === bookmarkId);
      if (!bm) return;

      const sourceGroupId = bm.groupId;

      if (!Array.isArray(state.bookmarkOrderMap[sourceGroupId])) state.bookmarkOrderMap[sourceGroupId] = [];
      if (!Array.isArray(state.bookmarkOrderMap[targetGroupId])) state.bookmarkOrderMap[targetGroupId] = [];

      // source Ï†úÍ±∞
      state.bookmarkOrderMap[sourceGroupId] = state.bookmarkOrderMap[sourceGroupId].filter(id => id !== bookmarkId);

      bm.groupId = targetGroupId;

      // target append
      const targetOrder = state.bookmarkOrderMap[targetGroupId].filter(id => id !== bookmarkId);
      targetOrder.push(bookmarkId);
      state.bookmarkOrderMap[targetGroupId] = targetOrder;
    }

    function moveBookmarkToGroupRelative(bookmarkId, targetGroupId, targetId, position) {
      const bm = state.bookmarks.find(b => b.id === bookmarkId);
      if (!bm) return;

      const sourceGroupId = bm.groupId;

      if (!Array.isArray(state.bookmarkOrderMap[sourceGroupId])) state.bookmarkOrderMap[sourceGroupId] = [];
      if (!Array.isArray(state.bookmarkOrderMap[targetGroupId])) state.bookmarkOrderMap[targetGroupId] = [];

      // source Ï†úÍ±∞
      state.bookmarkOrderMap[sourceGroupId] = state.bookmarkOrderMap[sourceGroupId].filter(id => id !== bookmarkId);

      bm.groupId = targetGroupId;

      const targetOrder = state.bookmarkOrderMap[targetGroupId].filter(id => id !== bookmarkId);

      const idx = targetOrder.indexOf(targetId);
      if (idx === -1) {
        targetOrder.push(bookmarkId);
      } else {
        const insertAt = (position === 'before') ? idx : (idx + 1);
        targetOrder.splice(insertAt, 0, bookmarkId);
      }

      state.bookmarkOrderMap[targetGroupId] = targetOrder;
    }

    // ==================== Group Management (rename/delete only here) ====================
    function openBookmarkGroupModal() {
      document.getElementById('bookmarkGroupModal').classList.add('active');
      renderBookmarkGroupList();
    }

    function renderBookmarkGroupList() {
      const container = document.getElementById('bookmarkGroupList');
      container.innerHTML = state.bookmarkGroups.map(g => {
        const count = (state.bookmarkOrderMap[g.id] || []).length;
        const disabled = g.id === 'default';

        return `
          <div style="display:flex; gap:8px; align-items:center; background: var(--bg-secondary); border:1px solid var(--border); padding:10px; border-radius:12px;">
            <div style="flex:1; min-width:0; color: var(--text-primary); font-size:0.92rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
              üìÅ ${escapeHtml(g.name)} <span style="color:var(--text-muted); font-size:0.8rem;">(${count})</span>
            </div>

            <button class="card-btn" type="button" onclick="renameBookmarkGroup('${g.id}')">Ïù¥Î¶ÑÎ≥ÄÍ≤Ω</button>
            <button class="card-btn" type="button"
              ${disabled ? 'disabled' : `onclick="deleteBookmarkGroup('${g.id}')"`}>
              ÏÇ≠Ï†ú
            </button>
          </div>
        `;
      }).join('');
    }

    function addBookmarkGroup() {
      const input = document.getElementById('newBookmarkGroupName');
      const name = (input.value || '').trim();
      if (!name) return;

      const id = uid('g');
      state.bookmarkGroups.push({ id, name });
      state.bookmarkOrderMap[id] = [];

      input.value = '';

      saveState();
      renderBookmarkGroupList();
      renderBookmarkGroups();
    }

    function renameBookmarkGroup(groupId) {
      const g = state.bookmarkGroups.find(x => x.id === groupId);
      if (!g) return;

      const next = prompt('Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî', g.name);
      if (next === null) return;

      const trimmed = next.trim();
      if (!trimmed) return;

      g.name = trimmed;
      saveState();
      renderBookmarkGroupList();
      renderBookmarkGroups();
    }

    function deleteBookmarkGroup(groupId) {
      if (groupId === 'default') return;

      const group = state.bookmarkGroups.find(g => g.id === groupId);
      const groupName = group ? group.name : 'Ïù¥ Í∑∏Î£π';

      if (!confirm(`${groupName}ÏùÑ(Î•º) ÏÇ≠Ï†úÌï†ÍπåÏöî?\nÍ∑∏Î£π ÏïàÏùò Î∂ÅÎßàÌÅ¨Îäî "Í∏∞Î≥∏" Í∑∏Î£πÏúºÎ°ú Ïù¥ÎèôÎê©ÎãàÎã§.`)) return;

      const movingIds = (state.bookmarkOrderMap[groupId] || []).slice();
      if (!Array.isArray(state.bookmarkOrderMap['default'])) state.bookmarkOrderMap['default'] = [];
      state.bookmarkOrderMap['default'] = [...state.bookmarkOrderMap['default'], ...movingIds];

      state.bookmarks = state.bookmarks.map(b => b.groupId === groupId ? { ...b, groupId: 'default' } : b);

      state.bookmarkGroups = state.bookmarkGroups.filter(g => g.id !== groupId);
      delete state.bookmarkOrderMap[groupId];

      saveState();
      renderBookmarkGroupList();
      renderBookmarkGroups();
    }

    // ==================== Calendar (Weekly) ====================
    function renderWeeklyCalendar() {
      const grid = document.getElementById('weekGrid');
      const weekLabel = document.getElementById('calendarWeekLabel');
      const weekStart = state.currentWeekStart;
      const todayStr = getLocalDateStr(new Date());

      const month = weekStart.getMonth() + 1;
      const weekOfMonth = Math.ceil((weekStart.getDate() + weekStart.getDay()) / 7);
      weekLabel.textContent = `${weekStart.getFullYear()}ÎÖÑ ${month}Ïõî ${weekOfMonth}Ï£ºÏ∞®`;

      const dayNames = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
      let html = '';

      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(date.getDate() + i);
        const dateStr = getLocalDateStr(date);

        const isToday = dateStr === todayStr;
        const isSelected = dateStr === state.selectedDate;

        const localEvents = state.events.filter(e => e.date === dateStr);
        const googleEvts = state.googleEvents.filter(e => e.date === dateStr);
        const allEvents = [...localEvents, ...googleEvts];

        let classes = 'week-day';
        if (isToday) classes += ' today';
        if (isSelected && !isToday) classes += ' selected';

        const dots = allEvents.slice(0, 3).map(() => '<span class="event-dot"></span>').join('');

        html += `
          <div class="${classes}" onclick="selectDate('${dateStr}')">
            <div class="week-day-name">${dayNames[i]}</div>
            <div class="week-day-num">${date.getDate()}</div>
            <div class="week-day-dots">${dots}</div>
          </div>
        `;
      }

      grid.innerHTML = html;
      renderEventsForDate(state.selectedDate);
    }

    function changeWeek(delta) {
      state.currentWeekStart.setDate(state.currentWeekStart.getDate() + (delta * 7));
      renderWeeklyCalendar();
      if (state.googleConnected) fetchGoogleCalendarEvents();
    }

    function goToToday() {
      state.currentWeekStart = getWeekStart(new Date());
      state.selectedDate = getLocalDateStr(new Date());
      renderWeeklyCalendar();
      if (state.googleConnected) fetchGoogleCalendarEvents();
    }

    function selectDate(dateStr) {
      state.selectedDate = dateStr;
      renderWeeklyCalendar();
    }

    function renderEventsForDate(dateStr) {
      const list = document.getElementById('eventsList');
      const header = document.getElementById('selectedDateHeader');

      const date = parseLocalDate(dateStr);
      header.textContent = date.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'long' });

      const localEvents = state.events.filter(e => e.date === dateStr).map(e => ({ ...e, source: 'local' }));
      const googleEvts = state.googleEvents.filter(e => e.date === dateStr).map(e => ({ ...e, source: 'google' }));
      const allEvents = [...localEvents, ...googleEvts].sort((a, b) => (a.time || '').localeCompare(b.time || ''));

      if (allEvents.length === 0) {
        list.innerHTML = '<div class="event-empty">Ïù¥ ÎÇ†Ïùò ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§</div>';
        return;
      }

      list.innerHTML = allEvents.map((e) => {
        const isGoogle = e.source === 'google';
        const timeDisplay = e.time || 'Ï¢ÖÏùº';
        return `
          <div class="event-item ${isGoogle ? 'google-event' : ''}">
            <div class="event-time">${timeDisplay}</div>
            <div class="event-title">${escapeHtml(e.title)}</div>
            ${isGoogle
              ? '<span class="event-source">Google</span>'
              : `<button class="card-btn" onclick="deleteEvent('${e.date}', '${escapeQuotes(e.title)}', '${e.time || ''}')" style="padding:3px 6px;font-size:0.7rem;">ÏÇ≠Ï†ú</button>`
            }
          </div>
        `;
      }).join('');
    }

    function openAddEventModal() {
      document.getElementById('eventModal').classList.add('active');
      document.getElementById('eventDate').value = state.selectedDate;
    }

    function addEvent(e) {
      e.preventDefault();
      state.events.push({
        title: document.getElementById('eventTitle').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value
      });
      saveState();
      renderWeeklyCalendar();
      closeModal('eventModal');
      e.target.reset();
    }

    function deleteEvent(date, title, time) {
      const idx = state.events.findIndex(e => e.date === date && e.title === title && (e.time || '') === time);
      if (idx > -1) {
        state.events.splice(idx, 1);
        saveState();
        renderWeeklyCalendar();
      }
    }

    // ==================== Google Calendar ====================
    function updateGoogleStatus() {
      const pill = document.getElementById('gPill');
      const text = document.getElementById('gPillText');
      const btnEl = document.getElementById('googleBtn');
      const selectBtnEl = document.getElementById('googleCalendarSelectBtn');

      if (state.googleConnected && state.googleAccessToken) {
        pill.classList.add('connected');
        text.textContent = 'Google Ïó∞Í≤∞Îê®';
        btnEl.textContent = 'Ïó∞Í≤∞ Ìï¥Ï†ú';
        selectBtnEl.style.display = 'inline-block';
      } else {
        pill.classList.remove('connected');
        text.textContent = 'Google ÎØ∏Ïó∞Í≤∞';
        btnEl.textContent = 'Google Ïó∞Í≤∞';
        selectBtnEl.style.display = 'none';
      }
    }

    function handleGoogleAuth() {
      if (state.googleConnected) {
        // Ïó∞Í≤∞ Ìï¥Ï†ú
        state.googleConnected = false;
        state.googleAccessToken = null;
        state.googleEvents = [];
        state.googleTokenExpiresAt = null;

        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('googleTokenExpiresAt');

        updateGoogleStatus();
        renderWeeklyCalendar();
        return;
      }

      // Implicit Flow: ÌÜ†ÌÅ∞ ÏûêÏ≤¥Í∞Ä ÏßßÏùå(ÎåÄÍ∞ú ~1ÏãúÍ∞Ñ).
      const redirectUri = window.location.origin + window.location.pathname;
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${encodeURIComponent(GOOGLE_SCOPES)}&prompt=consent`;
      window.location.href = authUrl;
    }

    function handleOAuthCallback() {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token')) {
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get('access_token');
        const expiresIn = Number(params.get('expires_in') || '0'); // ‚úÖ Î≥¥ÌÜµ Ï¥à Îã®ÏúÑ

        if (accessToken) {
          state.googleAccessToken = accessToken;
          state.googleConnected = true;
          localStorage.setItem('googleAccessToken', accessToken);

          if (expiresIn > 0) {
            state.googleTokenExpiresAt = Date.now() + expiresIn * 1000;
            localStorage.setItem('googleTokenExpiresAt', String(state.googleTokenExpiresAt));
          }

          window.history.replaceState({}, document.title, window.location.pathname);

          updateGoogleStatus();
          fetchGoogleCalendarList();
          fetchGoogleCalendarEvents();
        }
      }
    }

    function checkGoogleTokenExpiry() {
      if (!state.googleConnected || !state.googleAccessToken || !state.googleTokenExpiresAt) return;

      const msLeft = state.googleTokenExpiresAt - Date.now();
      // 2Î∂Ñ Ïù¥Ìïò ÎÇ®ÏúºÎ©¥ ÏïàÎÇ¥(ÏûêÎèô Ïû¨Ïó∞Ïû•ÏùÄ Ïù¥ ÌîåÎ°úÏö∞ÏóêÏÑ† Ïñ¥Î†µÍ≥†, Ïû¨Ïó∞Í≤∞Ïù¥ ÌïÑÏöî)
      if (msLeft > 0 && msLeft < 2 * 60 * 1000) {
        // ÎÑàÎ¨¥ ÏûêÏ£º Îú®Îäî Í±¥ Î∞©ÏßÄ(Ìïú Î≤àÎßå)
        if (!state.__warnedExpiry) {
          state.__warnedExpiry = true;
          alert('Google Ïù∏Ï¶ùÏù¥ Í≥ß ÎßåÎ£åÎê©ÎãàÎã§. ÎÅäÍ∏∞Î©¥ "Google Ïó∞Í≤∞"ÏùÑ Îã§Ïãú ÎàåÎü¨Ï£ºÏÑ∏Ïöî.');
        }
      }
      if (msLeft <= 0) {
        // ÎßåÎ£å Ï∂îÏ†ï: ÏÉÅÌÉúÎßå Ï†ïÎ¶¨(Ïã§Ï†úÎäî 401ÏóêÏÑú ÌôïÏ†ï)
        state.googleTokenExpiresAt = null;
        localStorage.removeItem('googleTokenExpiresAt');
      }
    }

    async function fetchGoogleCalendarList() {
      if (!state.googleAccessToken) return;
      try {
        const res = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {
          headers: { 'Authorization': `Bearer ${state.googleAccessToken}` }
        });

        if (res.status === 401) {
          handleGoogle401();
          return;
        }

        if (res.ok) {
          const data = await res.json();
          state.googleCalendars = data.items || [];

          if (state.selectedCalendars.length === 0) {
            state.selectedCalendars = state.googleCalendars.map(c => c.id);
            saveState();
          }
        }
      } catch (e) {
        console.error('Calendar list error:', e);
      }
    }

    async function openCalendarSelectModal() {
      document.getElementById('calendarSelectModal').classList.add('active');

      if (state.googleCalendars.length === 0) {
        await fetchGoogleCalendarList();
      }
      renderCalendarList();
    }

    function renderCalendarList() {
      const list = document.getElementById('calendarList');

      if (state.googleCalendars.length === 0) {
        list.innerHTML = '<div class="news-loading">Ï∫òÎ¶∞ÎçîÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
        return;
      }

      list.innerHTML = state.googleCalendars.map(cal => {
        const isChecked = state.selectedCalendars.includes(cal.id);
        const bgColor = cal.backgroundColor || '#4285f4';
        return `
          <label style="display:flex; align-items:center; gap:10px; padding:10px; background: var(--bg-secondary); border-radius:8px; margin-bottom:8px; cursor:pointer;">
            <input type="checkbox" value="${cal.id}" ${isChecked ? 'checked' : ''} style="width:18px; height:18px; accent-color:${bgColor};">
            <span style="width:12px; height:12px; background:${bgColor}; border-radius:3px;"></span>
            <span style="flex:1; color: var(--text-primary);">${escapeHtml(cal.summary)}</span>
          </label>
        `;
      }).join('');
    }

    function saveCalendarSelection() {
      const checkboxes = document.querySelectorAll('#calendarList input[type="checkbox"]');
      state.selectedCalendars = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

      saveState();
      closeModal('calendarSelectModal');
      fetchGoogleCalendarEvents();
    }

    function handleGoogle401() {
      state.googleConnected = false;
      state.googleAccessToken = null;
      state.googleEvents = [];
      state.googleTokenExpiresAt = null;
      state.__warnedExpiry = false;

      localStorage.removeItem('googleAccessToken');
      localStorage.removeItem('googleTokenExpiresAt');

      updateGoogleStatus();
      renderWeeklyCalendar();
      alert('Google Ïù∏Ï¶ùÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî.');
    }

    async function fetchGoogleCalendarEvents() {
      if (!state.googleAccessToken) return;

      try {
        const weekStart = new Date(state.currentWeekStart);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 7);

        const calendarsToFetch = state.selectedCalendars.length > 0 ? state.selectedCalendars : ['primary'];
        let allEvents = [];

        for (const calendarId of calendarsToFetch) {
          try {
            const res = await fetch(
              `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?timeMin=${encodeURIComponent(weekStart.toISOString())}&timeMax=${encodeURIComponent(weekEnd.toISOString())}&singleEvents=true&orderBy=startTime`,
              { headers: { 'Authorization': `Bearer ${state.googleAccessToken}` } }
            );

            if (res.status === 401) {
              handleGoogle401();
              return;
            }

            if (res.ok) {
              const data = await res.json();
              if (data.items) {
                const events = data.items.map(event => {
                  const start = event.start.dateTime || event.start.date;
                  let date, time;
                  if (event.start.dateTime) {
                    const d = new Date(start);
                    date = getLocalDateStr(d);
                    time = d.toTimeString().slice(0, 5);
                  } else {
                    date = start;
                    time = null;
                  }
                  return { id: event.id, title: event.summary || '(Ï†úÎ™© ÏóÜÏùå)', date, time, calendarId };
                });
                allEvents = allEvents.concat(events);
              }
            }
          } catch (e) {
            console.error(`Calendar ${calendarId} error:`, e);
          }
        }

        state.googleEvents = allEvents;
        renderWeeklyCalendar();
      } catch (e) {
        console.error('Google Calendar error:', e);
      }
    }

    // ==================== Memos ====================
    function renderMemos() {
      const grid = document.getElementById('memoGrid');

      let html = state.memos.map((m, i) => `
        <div class="memo-postit ${m.color || 'yellow'}" onclick="openEditMemo(${i})">
          <button class="memo-postit-delete" onclick="deleteMemo(event, ${i})">√ó</button>
          <div class="memo-postit-header">
            <div class="memo-postit-title">${escapeHtml(m.title)}</div>
          </div>
          <div class="memo-postit-content">${escapeHtml(m.content || '')}</div>
          <div class="memo-postit-date">${escapeHtml(m.date || '')}</div>
        </div>
      `).join('');

      html += `<div class="memo-postit memo-postit-add" onclick="openAddMemo()">+</div>`;
      grid.innerHTML = html;
    }

    function openAddMemo() {
      document.getElementById('memoModalTitle').textContent = 'Î©îÎ™® Ï∂îÍ∞Ä';
      document.getElementById('memoEditIndex').value = '-1';
      document.getElementById('memoTitle').value = '';
      document.getElementById('memoContent').value = '';
      selectColor('yellow');
      document.getElementById('memoModal').classList.add('active');
    }

    function openEditMemo(index) {
      const memo = state.memos[index];
      document.getElementById('memoModalTitle').textContent = 'Î©îÎ™® ÏàòÏ†ï';
      document.getElementById('memoEditIndex').value = index;
      document.getElementById('memoTitle').value = memo.title;
      document.getElementById('memoContent').value = memo.content;
      selectColor(memo.color || 'yellow');
      document.getElementById('memoModal').classList.add('active');
    }

    function selectColor(color) {
      state.selectedMemoColor = color;
      document.querySelectorAll('.color-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.color === color);
      });
    }

    function saveMemo(e) {
      e.preventDefault();
      const index = parseInt(document.getElementById('memoEditIndex').value);
      const dateStr = getLocalDateStr(new Date());

      const memo = {
        title: document.getElementById('memoTitle').value,
        content: document.getElementById('memoContent').value,
        color: state.selectedMemoColor,
        date: dateStr
      };

      if (index === -1) state.memos.push(memo);
      else state.memos[index] = memo;

      saveState();
      renderMemos();
      closeModal('memoModal');
    }

    function deleteMemo(e, index) {
      e.stopPropagation();
      if (confirm('Ïù¥ Î©îÎ™®Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        state.memos.splice(index, 1);
        saveState();
        renderMemos();
      }
    }

    function exportAllMemos() {
      if (state.memos.length === 0) {
        alert('ÎÇ¥Î≥¥ÎÇº Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.');
        return;
      }
      const wsData = [['Ï†úÎ™©', 'ÎÇ¥Ïö©', 'ÏÉâÏÉÅ', 'ÏûëÏÑ±Ïùº']];
      state.memos.forEach(m => wsData.push([m.title, m.content, m.color, m.date]));
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Î©îÎ™®');
      const filename = `memos_${getLocalDateStr(new Date())}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    // ==================== News (7 lines) ====================
    function renderNewsKeywords() {
      const container = document.getElementById('newsKeywords');
      container.innerHTML = state.newsKeywords.map(k => `
        <div class="news-keyword ${k === state.activeKeyword ? 'active' : ''}" onclick="selectKeyword('${escapeQuotes(k)}')">${escapeHtml(k)}</div>
      `).join('');
    }

    function selectKeyword(keyword) {
      state.activeKeyword = keyword;
      renderNewsKeywords();
      loadNews();
    }

    function openKeywordModal() {
      document.getElementById('keywordModal').classList.add('active');
      renderKeywordList();
    }

    function renderKeywordList() {
      document.getElementById('keywordList').innerHTML = state.newsKeywords.map(k => `
        <span class="news-keyword" onclick="deleteKeyword('${escapeQuotes(k)}')" style="cursor:pointer;">${escapeHtml(k)} √ó</span>
      `).join('');
    }

    function addKeyword(e) {
      e.preventDefault();
      const keyword = document.getElementById('newKeyword').value.trim();
      if (keyword && !state.newsKeywords.includes(keyword)) {
        state.newsKeywords.push(keyword);
        state.activeKeyword = keyword;
        saveState();
        renderNewsKeywords();
        renderKeywordList();
        loadNews();
      }
      document.getElementById('newKeyword').value = '';
    }

    function deleteKeyword(keyword) {
      if (state.newsKeywords.length > 1) {
        state.newsKeywords = state.newsKeywords.filter(k => k !== keyword);
        if (state.activeKeyword === keyword) state.activeKeyword = state.newsKeywords[0];
        saveState();
        renderNewsKeywords();
        renderKeywordList();
        loadNews();
      }
    }

    async function loadNews() {
      const list = document.getElementById('newsList');
      list.innerHTML = '<div class="news-loading">Îâ¥Ïä§Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë...</div>';
      try {
        const res = await fetch('news.json');
        const allNewsData = await res.json();
        if (allNewsData[state.activeKeyword]) renderNewsItems(allNewsData[state.activeKeyword]);
        else list.innerHTML = `<div class="news-loading">'${escapeHtml(state.activeKeyword)}'Ïóê ÎåÄÌïú Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.<br><small>Îã§Ïùå ÏóÖÎç∞Ïù¥Ìä∏Î•º Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</small></div>`;
      } catch (e) {
        list.innerHTML = '<div class="news-loading">Îâ¥Ïä§ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
      }
    }

    function renderNewsItems(items) {
      const list = document.getElementById('newsList');
      const displayItems = (items || []).slice(0, 7);
      if (displayItems.length === 0) {
        list.innerHTML = '<div class="news-loading">ÌëúÏãúÌï† Îâ¥Ïä§Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
        return;
      }
      list.innerHTML = displayItems.map(item => {
        const pubDate = new Date(item.pubDate);
        const timeAgo = getTimeAgo(pubDate);
        const cleanTitle = (item.title || '').replace(/<[^>]*>/g, '').replace(/&quot;/g, '"').replace(/&amp;/g, '&');
        return `
          <a href="${escapeHtml(item.link || '#')}" target="_blank" class="news-item">
            <span class="news-title">${escapeHtml(cleanTitle)}</span>
            <span class="news-time">${escapeHtml(timeAgo)}</span>
          </a>
        `;
      }).join('');
    }

    function getTimeAgo(date) {
      const diff = new Date() - date;
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (mins < 1) return 'Î∞©Í∏à';
      if (mins < 60) return mins + 'Î∂Ñ Ï†Ñ';
      if (hrs < 24) return hrs + 'ÏãúÍ∞Ñ Ï†Ñ';
      return days + 'Ïùº Ï†Ñ';
    }

    function refreshNews() { loadNews(); }

    // ==================== Modal ====================
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    });

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); });
    });

    // Start
    init();
  </script>
</body>
</html>
